import Feedback from '@site/src/components/Feedback';

# Блокчейн блокчейнов

:::tip
В этом тексте для простоты понятия **смарт-контракт**, **аккаунт** и **актор** используются взаимозаменяемо.
Технически, **аккаунт** в TON является **актором**, а **смарт-контракт** — это аккаунт с *развёрнутыми кодом и данными*.
:::

## Отдельный актор

В TON смарт-контракт — это *вычислительная сущность* со свойствами вроде `адреса`, `кода`, `данных` и `баланса`. Другими словами, это объект с постоянным хранилищем и определённым поведением.

Это поведение следует такой схеме:

- контракт получает сообщение
- он обрабатывает это событие в соответствии со своими свойствами, исполняя свой `код` в виртуальной машине TON
- он может обновить своё состояние, включая `код`, `данные` и `баланс`
- он может создать исходящие сообщения
- он прекращает активность до получения следующего сообщения

Успешная обработка сообщения по этим шагам представляет собой **транзакцию**.
Поскольку аккаунт взаимодействует с одним сообщением за раз, он обрабатывает сообщения в строгом порядке, транзакции не перекрывают друг друга и не прерываются.

Это поведение следует **модели акторов**, где каждый контракт — это независимая сущность, реагирующая на сообщения.

### Самый низкий уровень: AccountChain

Последовательность транзакций `Tx1 → Tx2 → Tx3 → …` можно назвать **цепочкой** (chain). Когда эта последовательность относится к одному аккаунту, для её обозначения используют понятие `AccountChain`.

Поскольку узлы, обрабатывающие эти транзакции, периодически должны синхронизировать состояние смарт-контракта для достижения консенсуса, транзакции объединяют в группы под названием **блоки**. Например, такие:

```text
[Tx1 → Tx2] → [Tx3 → Tx4 → Tx5] → [] → [Tx6]
```

Это группирование никак не видоизменяет саму последовательность. Каждая транзакция в ней по-прежнему ссылается ровно на одну предшествующую (`prev tx`), и у неё может быть не более одной следующей (`next tx`). Группирование просто делит эту последовательность на блоки, удобные для задачи достижения консенсуса.

Также каждый блок может содержать очереди входящих и исходящих сообщений. С ними в блоке гарантированно окажется полный набор событий и изменений состояния, произошедших со смарт-контрактом в период этого блока.

## Множество AccountChains: шарды

Теперь давайте рассмотрим множество аккаунтов. Мы можем взять набор AccountChain и хранить их вместе. Подобное множество AccountChains называется **шардчейном** (ShardChain). По аналогии с уже описанным выше, мы можем разбить такой шардчейн на **«шардблоки»** (ShardBlocks), которые будут являться совокупностью отдельных AccountBlock.

### Динамическое разделение и объединение шардчейнов

Поскольку шардчейн состоит из легко различимых AccountChain, мы можем его легко разделять. Если шардчейн описывает события, происходящие с миллионом аккаунтов, и транзакций в секунду становится слишком много для обработки одним узлом, мы **разделяем** эту цепочку на два шардчейна меньшего размера, каждый из которых отвечает за полмиллиона аккаунтов и обрабатывается отдельным подмножеством узлов.

Точно так же, если некоторые шарды становятся недостаточно загруженными, они могут снова **соединяться** в один.

Есть два предельных случая: когда шард содержит только один аккаунт (и, следовательно, не может быть разделён дальше) и когда шард содержит все аккаунты.

Аккаунты могут взаимодействовать друг с другом, отправляя сообщения. Существует специальный механизм маршрутизации, который перемещает сообщения из исходящих очередей в соответствующие входящие очереди и гарантирует:

1. Что все сообщения оказываются доставлены.
2. Что сообщения от аккаунта A аккаунту B будут доставлены в том же порядке, в котором они были отправлены. Однако если речь идёт сразу о многих аккаунтах, то порядок доставки сообщений не гарантируется.

:::info ПРИМЕЧАНИЕ
Чтобы разделение и слияние происходили детерминированным образом, объединение AccountChains в шарды основано на битовом представлении адресов аккаунтов. Получается разделение адреса на `(префикс шарда, адрес в шарде)`. Таким образом, все аккаунты в шарде будут иметь один двоичный префикс (например, все адреса будут начинаться с `0b00101`).
:::

## Воркчейн

Объединение всех шардов, содержащее все аккаунты, работающие по одному набору правил, называется воркчейном (WorkChain).

В TON может действовать много разных наборов правил и, следовательно, могут работать одновременно много воркчейнов. Они могут взаимодействовать друг с другом, отправляя сообщения так же, как аккаунты одного воркчейна могут взаимодействовать друг с другом.

### Воркчейн: блокчейн с вашими собственными правилами

Если вы хотите настроить свои правила для группы шардчейнов, вы можете создать **Воркчейн**. Например, теоретически возможно создать воркчейн с поддержкой EVM, чтобы запускать в TON смарт-контракты на языке Solidity. Но это сложная задача из-за различий TVM и EVM.

Теоретически любой в сообществе может предложить собственный воркчейн. Однако его создание — крайне трудоёмкая задача. Более того, для его создания необходимо заплатить ощутимую комиссию, а также получить при голосовании валидаторов одобрение от 2/3 из них.

TON позволяет создавать до `2^32` воркчейнов, каждый из которых может подразделяться на шарды числом до `2^60`.

В настоящее время в TON есть только два воркчейна: мастерчейн (masterchain) и бейсчейн (basechain).

В бейсчейне транзакции дешевле, поэтому он используется для повседневных транзакций между участниками, а мастерчейн выполняет важную для TON функцию.

### Мастерчейн

Необходимо синхронизировать маршрутизацию сообщений и выполнение транзакций. Другими словами, узлам сети нужен способ зафиксировать некоторую «точку» в состоянии всех цепочек, и достичь консенсуса относительно этого состояния. В TON для этой цели используется так называемый **мастерчейн** (MasterChain). Его блоки содержат дополнительную информацию, вроде хешей свежих блоков, обо всех других цепочках в этой системе. Таким образом, любой наблюдатель однозначно может определить состояние всей мультичейн-системы по одному блоку мастерчейна.

## См. также

- [Адреса смарт-контрактов](/v3/concepts/dive-into-ton/ton-blockchain/smart-contract-addresses)

<Feedback />
