import Feedback from '@site/src/components/Feedback';

# Blockchain of blockchains

:::tip
Термины **смарт-контракт**, **аккаунт** и **актор** используются взаимозаменяемо в этом документе для описания сущности блокчейна.
:::

## Отдельный актор

Рассмотрим один смарт-контракт.

В TON это _сущность_ с такими свойствами как `address`, `code`, `data`, `balance` и другие. Другими словами, это объект, который имеет _хранилище_ и определенное _поведение_.
Это поведение в основном принимает следующий вид:

- происходит событие (наиболее распространенная ситуация — контракт получает сообщение)
- контракт обрабатывает это событие в соответствии со своими свойствами, исполняя `код` в виртуальной машине TON.
- контракт изменяет свои свойства (`code`, `data` и другие)
- контракт опционально генерирует исходящие сообщения
- контракт переходит в режим ожидания, пока не произойдет следующее событие

Комбинация этих шагов называется **транзакцией**. Важно, чтобы описанные выше события обрабатывались одно за другим, поэтому _транзакции_ в блокчейне строго упорядочены и не могут прерывать друг друга.

This behavior pattern is well known and called **actor**.

### Самый низкий уровень: AccountChain

Последовательность _транзакций_ `Tx1 -> Tx2 -> Tx3 -> ....` можно назвать **цепочкой**. В рассматриваемом нами случае, так как эта _цепочка_ транзакций относится к одному аккаунту, мы можем использовать термин `AccountChain`.

Since nodes processing these transactions periodically need to synchronize the smart contract state to achieve consensus, transactions are grouped into batches called **blocks**. For instance:

```
[Tx1 → Tx2] → [Tx3 → Tx4 → Tx5] → [] → [Tx6]
```

Batching does not alter the underlying sequence. Each transaction still references exactly one preceding transaction (`prev tx`) and at most one succeeding transaction (`next tx`). Batching simply organizes this sequence into manageable blocks for consensus purposes.

Также будет целесообразно включать в _блоки_ и очереди входящих и исходящих сообщений. В этом случае _блок_ будет содержать полный набор информации, которая определяет и описывает, что произошло со смарт-контрактом во время исполнения этого блока.

## Множество AccountChains: Шарды

Теперь давайте рассмотрим множество аккаунтов. Мы можем получить несколько _AccountChains_ и хранить их вместе. Подобный набор _AccountChains_ называется _Шардчейн_.Схожим образом мы можем разбить **Шардчейн** на **Шардблоки**, которые будут являться совокупностью отдельных _AccountBlocks_.

### Динамическое разделение и объединение шардчейнов

Важно отметить, что поскольку _Шардчейн_ состоит из явно различимых _AccountChains_, мы сможем его легко разделять.К примеру, если у нас есть 1 _Шардчейн_, который описывает происходящие с 1 миллионом аккаунтов события, и в одну секунду происходит слишком много транзакций для обработки и хранения в одном узле, то мы можем просто разделить эту цепочку на два меньших _Шардчейна_. При этом каждая цепочка будет работать с выделенным полмиллионом аккаунтов, а также она будет обрабатываться на отдельном подмножестве узлов.

Аналогично, если некоторые шарды станут слишком свободными, их можно **объединить** в один более крупный шард.

Очевидно, что есть два предельных случая – когда шард содержит только один аккаунт (и, следовательно, не может быть разделен дальше) и когда шард содержит все аккаунты.

Аккаунты могут взаимодействовать друг с другом, отправляя сообщения.  Существует специальный механизм маршрутизации, который перемещает сообщения из исходящих очередей в соответствующие входящие очереди и гарантирует, что все сообщения будут _доставлены_, а также, что эти сообщения будут доставлены _последовательно_ (сообщение, отправленное раньше, достигнет получателя раньше).

1. The delivery of all messages
2. Consecutive delivery of messages — a message sent earlier will reach the destination earlier

:::info ПРИМЕЧАНИЕ
Чтобы сделать разделение и слияние детерминированными, агрегация AccountChains в шарды основана на битовом представлении адресов аккаунтов. Например, адрес выглядит как `(shard prefix, address)`. Таким образом, все аккаунты в шарде будут иметь точно такой же двоичный префикс (например, все адреса будут начинаться с `0b00101`).
:::

## Blockchain

Объединение всех шардов, содержащее все аккаунты, работающие по одному набору правил, называется **Блокчейном**.

В TON может быть много наборов правил и, следовательно, много блокчейнов. Все они будут работать одновременно, а также они могут взаимодействовать друг с другом, отправляя сообщения по всей цепочке таким же образом, как аккаунты одной цепочки могут взаимодействовать друг с другом.

### WorkChain: a blockchain with your own rules

Если вы хотите настроить свои правила группы шардчейнов, вы можете создать **Воркчейн**. Хорошим примером является создание воркчейна, который работает на базе EVM, чтобы запускать на нем смарт-контракты Solidity.

Теоретически, каждый в сообществе может создать собственный воркчейн. На деле же – это крайне трудоемкая задача. Более того, для его создания необходимо заплатить ощутимую цену, а также получить 2/3 голосов от валидаторов, которые необходимы для одобрения создания вашего Воркчейна.

TON позволяет создавать до `2^32` воркчейнов, каждый из которых подразделяется на `2^60` шардов.

В настоящее время в TON есть только два воркчейна: Мастерчейн и Бейсчейн.

Бейсчейн используется для повседневных транзакций между участниками, ввиду его дешевизны. В свою очередь Мастерчейн выполняет важную для TON функцию.

### MasterChain: blockchain of blockchains

В блокчейне существует необходимость в синхронизации маршрутизации сообщений и выполнения транзакций. Другими словами, узлам сети нужен способ зафиксировать некоторую "точку" в состоянии мультичейна и достичь консенсуса относительно этого состояния.В TON для этой цели используется специальная цепочка под названием **Мастерчейн**. Блоки _Мастерчейна_ содержат дополнительную информацию, последние хэши блоков, обо всех других цепочках в этой системе. Таким образом, любой наблюдатель однозначно может определить состояние всех систем мультичейна в одном блоке Мастерчейна.

## See also

- [Smart contract addresses](/v3/concepts/dive-into-ton/ton-blockchain/smart-contract-addresses)

<Feedback />

