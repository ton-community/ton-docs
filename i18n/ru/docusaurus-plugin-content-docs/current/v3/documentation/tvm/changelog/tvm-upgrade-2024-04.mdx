import Feedback from '@site/src/components/Feedback';

# Обновление TVM 2024.04

## Добавлены новые инструкции по расчету дешевых комиссионных сборов

:::tip
Это обновление активно в основной сети с 16 марта (см. https://t.me/tonstatus/101). See the details [here](https://t.me/tonstatus/101). Предварительный просмотр этого обновления для blueprint доступен в пакетах `@ton/sandbox@0.16.0-tvmbeta.3`, `@ton-community/func-js@0.6.3-tvmbeta.3` и `@ton-community/func-js-bin@0.4.5-tvmbeta.3`.
:::

Это обновление активируется Config8 `version` >= 6.

## c7

**c7** кортеж расширен с 14 до 16 элементов:

* **14**: кортеж, содержащий некоторые параметры конфигурации в виде срезов ячеек. Если параметр отсутствует в конфигурации, значение равно null.
  * **0**: `StoragePrices` из `ConfigParam 18`. Не весь словарь, а только одна запись StoragePrices, которая соответствует текущему времени.
  * **1**: `ConfigParam 19` (глобальный идентификатор).
  * **2**: `ConfigParam 20` (цены на газ mc).
  * **3**: `ConfigParam 21` (цены на газ).
  * **4**: `ConfigParam 24` (стоимость пересылки mc).
  * **5**: `ConfigParam 25` (стоимость пересылки).
  * **6**: `ConfigParam 43` (ограничения по размеру).
* **15**: "[причитающийся платеж](https://github.com/ton-blockchain/ton/blob/8a9ff339927b22b72819c5125428b70c406da631/crypto/block/block.tlb#L237)" - текущий долг за плату за хранение (nanoton). Код операции Asm: `DUEPAYMENT`.
* **16**: "использование предварительно скомпилированного газа" - использование газа для текущего контракта, если он предварительно скомпилирован (см. ConfigParam 45), в противном случае null.
  Код операции Asm: `GETPRECOMPILEDGAS`.

The extension of `c7` with unpacked config parameters aims to improve efficiency. Now, this data is retrieved from the global configuration by the transaction executor, making it readily available in the executor's memory. Previously, the smart contract had to fetch each parameter one by one from the configuration dictionary. This method was costly and gas-inefficient, as the cost depended on the number of parameters.

**Due payment field**

The due payment field is crucial for accurately managing storage fees. Here's how it works:

* Необходима оплата по факту, чтобы контракт мог правильно оценить плату за хранение: когда сообщение отправляется в режиме по умолчанию (возвращаемом) в смарт-контракт, плата за хранение вычитается (или добавляется в поле due_payment, содержащее долг, связанный с платой за хранение), предыдущее значение сообщения добавляется к балансу.
  * **Deducted**, or
  * **Added** to the `due_payment` field, which stores the storage fee-related debt.
* These adjustments happen **before** the message value is added to the contract's balance.
* If the contract processes the message and sends back excess gas with `mode=64`, the following occurs:
  * Таким образом, если контракт после обработки сообщения отправляет излишки газа обратно с режимом = 64, это означает, что если баланс контракта достигнет 0, при следующих транзакциях плата за хранение начнет накапливаться в due_payment (а не вычитаться из входящих сообщений).
  * This results in the debt silently accumulating until the account is frozen.

The `DUEPAYMENT` opcode allows developers to explicitly account for or withhold storage fees, preventing potential issues.

## Новые коды операций

### Коды операций для работы с новыми значениями c7

26 газа для каждого, за исключением `SENDMSG` (из-за операций с ячейками).

| <br />Синтаксис Fift  | Stack             | Description                                                                                                                     |
| :-------------------- | :---------------- | :------------------------------------------------------------------------------------------------------------------------------ |
| `UNPACKEDCONFIGTUPLE` | *`- c`*           | Извлекает кортеж срезов конфигураций из c7                                                                                      |
| `DUEPAYMENT`          | *`- i`*           | Извлекает значение причитающегося платежа из c7                                                                                 |
| `GLOBALID`            | *`- i`*           | Теперь извлекает `ConfigParam 19` из from c7, формируя словарь конфигурации.                                                    |
| `SENDMSG`             | Режим *`msg - i`* | Теперь извлекает `ConfigParam 24/25` (цены сообщений) и `ConfigParam 43` (`max_msg_cells`) из c7, а не из словаря конфигурации. |

### Коды операций для обработки параметров конфигурации

Введение кортежа срезов конфигураций в исполнителе транзакций TON сделало анализ параметров комиссии более экономичным. Однако, поскольку в будущем могут быть введены новые конструкторы параметров конфигурации, может потребоваться обновление смарт-контрактов для интерпретации этих новых параметров.

Для решения этой проблемы были введены специальные коды операций для расчета платы. These opcodes:

* Retrieve parameters from `c7`.
* Calculate fees in the same way as the executor.

С введением новых конструкторов параметров эти коды операций будут обновлены для учета изменений. Это позволяет смарт-контрактам полагаться на эти инструкции для расчета платы без необходимости интерпретировать все типы конструкторов.

26 газа для каждого.

| <br />Синтаксис Fift  | Stack                                | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| :-------------------- | :----------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `GETGASFEE`           | *`gas_used is_mc - price`*           | Рассчитывает стоимость вычислений в nanoton для транзакции, которая потребляет *`gas_used`* газа.                                                                                                                                                                                                                                                                                                                                                                                                                |
| `GETSTORAGEFEE`       | *`cells bits seconds is_mc - price`* | Рассчитывает плату за хранение в nanoton для контракта на основе текущих цен на хранение. `cells` и `bits` — это размер [`AccountState`](https://github.com/ton-blockchain/ton/blob/8a9ff339927b22b72819c5125428b70c406da631/crypto/block/block.tlb#L247) (с дедупликацией, включая корневую ячейку).                                                                                                                                                                                                            |
| `GETFORWARDFEE`       | *`cells bits is_mc - price`*         | Calculates forward fees in nanotons for an outgoing message.Calculates forward fees in nanotons for an outgoing message.Calculates forward fees in nanotons for an outgoing message.`is_mc` is true if the source or the destination is in the MasterChain and false if both are in the basechain. Обратите внимание, что ячейки и биты в сообщении следует подсчитывать с учетом дедупликации и правил *root-is-not-counted*.                                                                                   |
| `GETPRECOMPILEDGAS`   | *`- null`*                           | зарезервировано, в настоящее время возвращает `null`. Возвращает стоимость выполнения контракта в единицах газа, если этот контракт *предварительно скомпилирован*                                                                                                                                                                                                                                                                                                                                               |
| `GETORIGINALFWDFEE`   | *`fwd_fee is_mc - orig_fwd_fee`*     | вычисляет `fwd_fee * 2^16 / first_frac`. Может использоваться для получения исходного `fwd_fee` сообщения (в качестве замены для жестко закодированных значений, таких как [это](https://github.com/ton-blockchain/token-contract/blob/21e7844fa6dbed34e0f4c70eb5f0824409640a30/ft/jetton-wallet.fc#L224C17-L224C46)) из `fwd_fee`, проанализированного из входящего сообщения. *`is_mc`* имеет значение true, если отправитель или получатель находятся в мастерчейне, и false, если оба находятся в бейсчейне. |
| `GETGASFEESIMPLE`     | *`gas_used is_mc - price`*           | Рассчитывает дополнительные вычислительные затраты в nanoton для транзакции, которая потребляет дополнительные *`gas_used`*. Другими словами, то же самое, что `GETFORWARDFEESIMPLE`, но без фиксированной цены (просто `(gas_used * price) / 2^16`).                                                                                                                                                                                                                                                            |
| `GETFORWARDFEESIMPLE` | *`cells bits is_mc - price`*         | Вычисляет дополнительную стоимость пересылки в nanoton для сообщения, содержащего дополнительные *`cells`* и *`bits`*. Другими словами, то же самое, что `GETFORWARDFEE`, но без фиксированной цены (просто `(bits*bit_price + cells*cell_price) / 2^16`).                                                                                                                                                                                                                                                       |

`gas_used`, `cells`, `bits`, `time_delta` — целые числа в диапазоне `0..2^63-1`.

### Операции на уровне ячеек

Операции для работы с доказательствами Меркла, где ячейки могут иметь ненулевой уровень и несколько хешей. 26 газа для каждого.

| <br />Синтаксис Fift | Stack                 | Description                      |
| :------------------- | :-------------------- | :------------------------------- |
| `CLEVEL`             | *`cell - level`*      | Возвращает уровень ячейки        |
| `CLEVELMASK`         | *`cell - level_mask`* | Возвращает маску уровня ячейки   |
| `i CHASHI`           | *`cell - hash`*       | Возвращает `i`-й хэш ячейки      |
| `i CDEPTHI`          | *`cell - depth`*      | Возвращает `i`-ую глубину ячейки |
| `CHASHIX`            | *`cell i - depth`*    | Возвращает `i`-й хэш ячейки      |
| `CDEPTHIX`           | *`cell i - depth`*    | Возвращает `i`-ую глубину ячейки |

`i` находится в диапазоне `0..3`.

<Feedback />
