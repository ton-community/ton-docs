import Feedback from '@site/src/components/Feedback';

# Спецификация RUNVM

В настоящее время у кода в TVM нет возможности вызывать внешний ненадежный код "в изолированной среде". Другими словами, внешний код всегда может необратимо обновить код, данные контракта или установить действия (например, отправить все деньги).

Инструкция `RUNVM` позволяет создать независимый экземпляр VM, запустить нужный код и получить необходимые данные (стек, регистры, потребление газа и т. д.) без риска загрязнения состояния вызывающей стороны. Запуск произвольного кода безопасным способом может быть полезен для [плагинов в стиле v4](/v3/documentation/smart-contracts/contracts-specs/wallet-contracts#wallet-v4), расчета субконтракта в стиле `init` Tact и т. д.

| Fift syntax   | Stack                                                                                                    | Description                                                                                                                                                                                                                                                                                                                                                                                                          |
| :------------ | :------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `flags RUNVM` | _`x_1 ... x_n n code [r] [c4] [c7] [g_l] [g_m] - x'_1 ... x'_m exitcode [data'] [c4'] [c5] [g_c]`_       | Запускает дочернюю VM с кодом `code` и стеком `x_1...x_n`. x_n`. Returns the modified stack `x'_1 ... Возвращает результирующий стек `x'_1...x'_m` и код выхода.<br/> Другие аргументы и возвращаемые значения включаются флагами, см. ниже. See details below.                                                                                                                                                      |
| `RUNVMX`      | _`x_1 ... x_n n code [r] [c4] [c7] [g_l] [g_m] flags - x'_1 ... x'_m exitcode [data'] [c4'] [c5] [g_c]`_ | То же самое, но выводит флаги из стека.                                                                                                                                                                                                                                                                                                                                                                              |

Флаги похожи на `runvmx` в fift:

- `+1`: установить c3 в код
- `+2`: ввести неявный 0 перед запуском кода `+2`: ввести неявный 0 перед запуском кода Note, it only works with +1 flag set Note, it only works with +1 flag set
- `+4`: взять `c4` из стека (постоянные данные), вернуть его окончательное значение
- `+8`: взять лимит газа "g_l" из стека, вернуть потребленный газ "g_c"
- `+16`: взять `c7` из стека (контекст смарт-контракта)
- `+32`: вернуть конечное значение `c5` (действия)
- `+64`: выводит жесткий лимит газа (включен ACCEPT) `g_m` из стека
- `+128`: "изолированное потребление газа". Дочерняя VM будет иметь отдельный набор посещенных ячеек и отдельный счетчик chksgn.
- `+256`: выводит целое число `r`, возвращает ровно `r` значений сверху:
  - Если вызов RUNVM успешен и r установлено, он возвращает r элементов. Если r не установлено - возвращает все;
  - Если RUNVM успешен, но в стеке недостаточно элементов (глубина стека меньше r), это рассматривается как исключение в дочерней VM с exit_code=-3 и exit_arg=0 (поэтому 0 возвращается как единственный элемент стека); Если RUNVM успешен, но в стеке недостаточно элементов (глубина стека меньше r), это рассматривается как исключение в дочерней VM с exit_code=-3 и exit_arg=0 (поэтому 0 возвращается как единственный элемент стека); The `exit_code` is set to `-3`, and `exit_arg` is set to `0`, so `0` is returned as the only stack element. Если RUNVM успешен, но в стеке недостаточно элементов (глубина стека меньше r), это рассматривается как исключение в дочерней VM с exit_code=-3 и exit_arg=0 (поэтому 0 возвращается как единственный элемент стека); The `exit_code` is set to `-3`, and `exit_arg` is set to `0`, so `0` is returned as the only stack element.
  - Если RUNVM завершается с исключением - возвращается только один элемент - exit arg (не путать с exit_code);
  - В случае OOG exit_code = -14 и exit_arg - это количество газа.

Стоимость газа:

- 66 газа
- 1 газ за каждый элемент стека, переданный дочерней виртуальной машине (первые 32 бесплатны)
- 1 газ за каждый элемент стека, возвращенный дочерней виртуальной машиной (первые 32 бесплатны)

## См. также

- [Инструкции TVM](/v3/documentation/tvm/instructions)

<Feedback />
