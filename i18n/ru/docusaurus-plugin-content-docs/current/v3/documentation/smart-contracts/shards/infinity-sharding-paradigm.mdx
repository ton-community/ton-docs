import Feedback from '@site/src/components/Feedback';

# Парадигма бесконечного шардинга

## Понимание разделенного слияния в блокчейне TON

Блокчейн TON (The Open Network) представляет инновационные концепции масштабируемости и эффективности блокчейна. Одной из таких концепций является функциональность разделения и объединения, которая является неотъемлемой частью его архитектуры блокчейна. В этой короткой статье рассматриваются ключевые аспекты разделения и объединения в блокчейне TON с упором на его роль в парадигме бесконечного шардинга (Infinite Sharding Paradigm - ISP).

#### Парадигма бесконечного шардинга (ISP) и ее применение

ISP лежит в основе дизайна блокчейна TON, рассматривая каждый аккаунт как часть своего отдельного "аккаунтчейна". Затем эти аккаунтчейны объединяются в блоки шардчейна для эффективности. Состояние шардчейна включает в себя состояния всех его аккаунтчейнов. Таким образом, блок шардчейна по сути представляет собой набор виртуальных блоков аккаунтов, назначенных ему.

- **ShardState**: приближенно как Hashmap(n, AccountState), где n — это длина бит account_id.
- **ShardBlock**: приближенно как Hashmap(n, AccountBlock).

Каждый шардчейн или, точнее, каждый блок шардчейна идентифицируется комбинацией `workchain_id` и двоичного префикса `s` из account_id.

## Алгоритм принятия решения о разделении или слиянии

Валидаторы решают, разделять или сливать шарды, следующим образом:

1. Для каждого блока вычисляются размер блока, расход газа и изменение lt.
2. These metrics are used to determine whether the block is **overloaded** or **underloaded**.
3. Каждый шард хранит историю недогрузки и перегрузки. Если достаточное количество недавних блоков были недогружены или перегружены, устанавливается флаг `want_merge` или `want_split`.
4. Validators make split or merge decisions using these flags by configuration parameters.

### 1. Оценка текущего состояния блока

Each block includes three core parameters that are used to assess load:

1. _Оценка размера блока_ - не фактический размер блока, а оценка, рассчитанная во время сопоставления.
2. _Потребление газа_ - общее количество газа, потребленного во всех транзакциях (за исключением специальных транзакций ticktock и mint/recover).
3. _Lt delta_ - разница между началом и концом lt блока.

### 2. Ограничения блоков и классификация

Ограничения блоков загружаются из [параметров конфигурации 22 и 23](/v3/documentation/network/configs/blockchain-configs#param-22-and-23).
Каждый из трех параметров имеет три ограничения: недогрузка, мягкое и жесткое:

#### Threshold table

| **Parameter**     | **Underload / Soft / Hard (BaseChain)**                | **Underload / Soft / Hard (MasterChain)**  |
| ----------------- | ------------------------------------------------------ | ------------------------------------------ |
| Block size        | _Размер блока_: `128/256/512 KiB`.                     | N/A                                        |
| Gas consumption   | 2M / 10M / 20M                                         | 200K / 1M / 2.5M                           |
| LT delta          | _Lt delta_: `1000/5000/10000`.                         | Same as BaseChain                          |

Также есть средний предел, который равен `(soft + hard) / 2`.

Каждый блок имеет следующие параметры.

- `0` - не достигнут предел допустимой нагрузки.
- `1` - превышен предел допустимой нагрузки.
- `2` - превышен мягкий предел.
- `3` - превышен средний предел.
- `4` - превышен жесткий предел.

Мы классифицируем три параметра (размер, газ и lt delta) по категориям:

Например: если классификация по размеру равна 2, классификация по газу равна 3, классификация по lt delta равна 1, то итоговая классификация блока равна 3.

Based on classification:

- 0 (Underload): merge candidate.
- 2 (Soft): internal messages are no longer processed; candidate for split.
- 3 (Medium): external messages are skipped.

### 3. Определение перегрузки или недогрузки

Additional heuristics are applied beyond classification based on the message queue status:

- A block is **overloaded** if:
  - Если класс блока ≥ `2` (мягкий) и размер очереди сообщений ≤ `SPLIT_MAX_QUEUE_SIZE = 100000`, то блок перегружен.
  - Если достигнут предел для общего количества обработанных сообщений из очереди отправки и размер очереди сообщений ≤ `SPLIT_MAX_QUEUE_SIZE = 100000`, то блок перегружен.
  - Если размер очереди сообщений ≥ `FORCE_SPLIT_QUEUE_SIZE = 4096` и ≤ `SPLIT_MAX_QUEUE_SIZE = 100000`, то блок перегружен.
- A block is **underloaded** if:
  - Если класс блока равен `0` (недогрузка) и размер очереди сообщений ≤ `MERGE_MAX_QUEUE_SIZE = 2047`, то блок недогружен.

### 4. Решение о разделении или слиянии

Каждый блок хранит историю недогрузки и перегрузки — это 64-битная маска статуса недогрузки/перегрузки последних 64 блоков. Она используется для принятия решения о разделении или слиянии.

The underload and overload histories are evaluated using a weighted formula:

История недогрузки и перегрузки имеет вес, который рассчитывается следующим образом:
`one_bits(mask & 0xffff) * 3 + one_bits(mask & 0xffff0000) * 2 + one_bits(mask & 0xffff00000000) - (3 + 2 + 1) * 16 * 2 / 3`
(здесь `one_bits` - это количество `1`-битов в маске, а младшие биты соответствуют самым последним блокам).

Here, `one_bits` counts the number of `1`-bits in the mask. Lower-order bits correspond to the most recent blocks.

Когда история недогрузки или перегрузки имеет неотрицательный вес, устанавливается флаг `want_merge` или `want_split`.

### 5. Окончательное решение

Валидаторы решают разделить или объединить шарды, используя флаги `want_split` и `want_merge` и [параметры конфигурации воркчейна](/v3/documentation/network/configs/blockchain-configs#param-12).

Валидаторы объединяют или разделяют шарды, используя эти флаги.

- Если шард имеет глубину < `min_split`, то он разделится.
- Если шард имеет глубину > `max_split`, то он объединится.
- Шарды с глубиной `min_split` не могут объединяться, шарды с глубиной `max_split` не могут разделяться.
- Если блок имеет флаг `want_split`, шард разделится.
- Если у блока и его дочернего элемента есть флаг `want_merge`, шарды объединятся.

Шарды разделяются и объединяются через `split_merge_delay = 100` секунд после принятия решения.

## Сообщения и мгновенная маршрутизация гиперкуба (мгновенная маршрутизация гиперкуба)

В парадигме бесконечного шардинга каждый аккаунт (или смарт-контракт) рассматривается так, как если бы он сам находился в отдельном шардчейне.
Взаимодействие между аккаунтами происходит исключительно посредством отправки сообщений, что является частью модели субъекта, где аккаунты выступают в качестве субъектов.
Эффективная система обмена сообщениями между шардчейнами имеет решающее значение для работы блокчейна TON. A key feature supporting this is **Instant Hypercube Routing**, which enables near-instantaneous message delivery and processing across ShardChains. Messages created in one ShardChain block are processed in the next block of the target ShardChain — regardless of how many messages are in the system.

### Current Status of IHR

:::info Important Clarification

- **IHR is not implemented** and is not yet fully specified
- **IHR is only relevant** when there are more than 16 shards and not all shards are neighbors to each other
- **Current network settings forbid splitting deeper than 16 shards**, so IHR is not relevant in any practical sense today

Currently, TON uses standard **Hypercube Routing (HR)** for message delivery between shards, which routes messages through intermediate shards when necessary. IHR would provide a more direct routing mechanism, but only becomes necessary in much larger shard configurations than are currently possible.
:::

### Message Routing Mechanisms

TON blockchain supports two conceptual message routing mechanisms:

1. **Hypercube Routing (HR)** - Currently implemented mechanism that routes messages between shards through intermediate hops when necessary
2. **Instant Hypercube Routing (IHR)** - Alternative mechanism (not implemented) that would allow direct message delivery without intermediate hops

The choice between these mechanisms would depend on the network topology and shard configuration, but given current limitations on shard depth, only HR is relevant.

## Пример шардинга

![](/img/docs/blockchain-fundamentals/shardchains.jpg)

На представленной графической схеме:

- Шарды воркчейна разделены по времени и обозначены пунктирной линией.
- Блоки 222, 223 и 224 относятся к блоку мастерчейна с seqno=102. Здесь 222 находится в одном шарде, а 223 и 224 — в другом.
- Если происходит событие разделения или слияния, затронутые шарды приостанавливаются до следующего блока мастерчейна.

Подводя итог, можно сказать, что разделение и слияние в блокчейне TON — это сложный, но эффективный механизм, который повышает масштабируемость и взаимодействие в сети блокчейнов. Он иллюстрирует подход TON к решению общих проблем блокчейнов, подчеркивая эффективность и глобальную согласованность.

## Подробности шардинга

#### Разделенные и неразделенные части шардчейна

Блок и состояние шардчейна делятся на две части:

1. **Разделенная часть**: соблюдает форму провайдера (ISP), содержащую специфические данные аккаунтов.
2. **Неразделенная часть**: включает данные, относящиеся к взаимодействию блока с другими блоками и внешним миром.

#### Взаимодействие с другими блоками

The non-split parts are vital in maintaining global consistency across the network. Неразделенные части имеют решающее значение для обеспечения глобальной согласованности, сведенной к внутренним и внешним локальным условиям согласованности. Они важны для:

- Пересылки сообщений между шардчейнами.
- Facilitating cross-shard transactions
- Гарантий доставки и проверки начального состояния блока по сравнению с его предшественником.

#### Входящие и исходящие сообщения

Ключевые компоненты неразделенной части блока шардчейна включают:

- **InMsgDescr**: describes all messages imported into the block. These messages are either:
  - processed by a block or transit transaction, i.e., temporarily forwarded as per `Hypercube Routing`.
- **OutMsgDescr**: Описания всех сообщений, экспортированных или сгенерированных блоком (т. е. либо сообщения, сгенерированные транзакцией, включенной в блок, либо транзитные сообщения с пунктом назначения, не принадлежащим текущему шардчейну, перенаправленные из `InMsgDescr`). These may be:
  - newly generated messages from a transaction in the block or
  - transit messages are forwarded to a destination outside the current ShardChain forwarded from `InMsgDescr`.

#### Заголовок блока и подписи валидатора

Если классификация блока равна 0 (недостаточная нагрузка), блок склонен к объединению со своим родственным блоком.

- `workchain_id`
- Binary prefix of `account_ids`
- Block sequence number. The smallest non-negative integer greater than its predecessors' sequence numbers.
- Logical time and UNIX time of generation
- Hashes of:
  - The block's predecessor(s) (two, in the case of a merge)
  - The block's initial and final states
  - The latest known MasterChain block at the time of block generation

After the block is created, validator signatures are appended to produce a signed block.

#### Исходящая очередь сообщений

`OutMsgQueue` в состоянии щардчейна является критической неразделенной частью. Она содержит недоставленные сообщения, включенные в `OutMsgDescr`, либо последним блоком шардчейна, ведущим к этому состоянию, либо одним из его предшественников.
Изначально каждое исходящее сообщение включается в `OutMsgQueue` и хранится там, пока они не будут обработаны или доставлены по назначению.

#### Механика разделения и слияния шардов

В контексте динамического шардинга конфигурации шардов могут меняться из-за событий разделения и слияния. Эти события синхронизируются с блоком мастерчейна.
Например, если происходит разделение или слияние, затронутые шарды ждут следующего блока мастерчейна, прежде чем продолжить.

## См. также

- [Блочная компоновка](/v3/documentation/data-formats/tlb/block-layout)
- [Технические документы](/v3/documentation/whitepapers/overview)

<Feedback />
