import Feedback from '@site/src/components/Feedback';

# Контракт на вестинг

The vesting contract is a smart contract implementation on the TON blockchain, enabling secure, scheduled distribution of Toncoin assets. This contract provides a robust framework for token management, ensuring the controlled release of funds based on predetermined schedules and conditions.

## Core functionality

The contract is a secure escrow service that locks a specified amount of Toncoin for a defined period and gradually releases it according to configurable parameters. This mechanism ensures predictable token distribution while maintaining strict control over asset release schedules.

## Этот контракт позволяет вам заблокировать определенное количество Toncoin на определенное время и постепенно разблокировать их.

During deployment, the system establishes the following parameters, which cannot be changed and remain fixed throughout the entire duration of the contract:

| Параметры вестинга                                                                                 | Description                                                                               | Example values                                                                     |
| -------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------- |
| `vesting_total_amount`                                                                             | `vesting_total_amount` - в nanoton, общее количество заблокированных Toncoin.             | 500 TON                                                                            |
| `vesting_start_time`                                                                               | Unix timestamp marking vesting period beginning                                           | Current time + delay                                                               |
| `vesting_total_duration`                                                                           | Total vesting period duration (seconds)                                                   | 31104000 (one year)                                                                |
| `unlock_period` - период разблокировки в секундах (например, `2592000` один раз в месяц).          | Time interval between releases (seconds)                                                  | 2592000 (monthly)                                                                  |
| `cliff_duration`                                                                                   | Initial lock period before first release                                                  | 5184000 (two months)                                                               |
| `vesting_sender_address`                                                                           | Authorized address for locked funds management                                            | Пополнение                                                                         |
| `owner_address`                                                                                    | Beneficiary address for Toncoin distribution                                              | Параметры вестинга не изменяются и устанавливаются во время развертывания.         |

Вы можете получить эти параметры с помощью метода `get_vesting_data()` get-method.

Параметры должны удовлетворять следующим условиям:

```
vesting_total_duration > 0
vesting_total_duration <= 135 years (2^32 seconds)
unlock_period > 0
unlock_period <= vesting_total_duration
cliff_duration >= 0
cliff_duration < vesting_total_duration
vesting_total_duration mod unlock_period == 0
cliff_duration mod unlock_period == 0
```

Хотя смарт-контракт не проверяет соответствие этим условиям, после развертывания контракта и перед отправкой ему Toncoin пользователь может проверить, что все параметры в порядке, с помощью метода get-method.

## Блокировка

До `vesting_start_time` все `vesting_total_amount` заблокированы.

Начиная с `vesting_start_time` сумма начинает пропорционально разблокироваться. Например, если `vesting_total_duration` составляет 10 месяцев, а `unlock_period` - 1 месяц, а `vesting_total_amount` - 500 TON, то каждый месяц будет разблокироваться 500\*(10/100)=50 TON, и через 10 месяцев будут разблокированы все 500 TON.

If a cliff period exists, no amount unlocks during that time. Once the cliff period ends, the contract unlocking according to the same formula. Например, если `cliff_period` составляет 3 месяца, а другие параметры такие же, как в предыдущем примере, то первые 3 месяца ничего не будет разблокировано, а через 3 месяца сразу будет разблокировано 150 TON (а затем по 50 TON каждый месяц).

Метод получения `get_locked_amount(int at_time)` позволяет рассчитать, сколько будет заблокировано в определенный момент времени. Вы можете отправлять заблокированные Toncoin только на адреса из белого списка или `vesting_sender_address`. Вы можете отправлять разблокированные Toncoin когда и куда захотите.

## Белый список

Белый список — это список адресов, на которые вы можете отправлять Toncoin, даже если монеты все еще заблокированы.

Метод получения `get_whitelist()` возвращает все адреса из белого списка в виде списка кортежей (wc, hash_part). Метод получения `is_whitelisted(slice address)` проверяет, находится ли этот адрес в белом списке.

`vesting_sender_address` может добавлять новые адреса в белый список в любое время с помощью сообщения `op::add_whitelist`. Кроме того, заблокированные монеты всегда можно отправлять на `vesting_sender_address` (их не нужно отдельно добавлять в белый список).

## Top-up

Вы можете отправлять Toncoin в контракт вестинга с любого адреса.

## Смарт-контракт кошелька

Этот контракт разработан аналогично [стандартному смарт-контракту кошелька V3](https://github.com/ton-blockchain/ton/blob/master/crypto/smartcont/wallet3-code.fc).

В своих данных он хранит `seqno`, `subwallet_id`, `public_key` и принимает внешние сообщения того же формата. В отличие от стандартного кошелька, контракт вестинга позволяет отправлять только одно сообщение за раз.

## Отправка

Владелец открытого ключа может инициировать отправку Toncoin из контракта вестинга внешним сообщением, как в стандартных кошельках.

Отправка Toncoin также может быть инициирована внутренним сообщением `op::send`, отправленным с `owner_address`. На практике и открытый ключ, и `owner_address` принадлежат одному и тому же пользователю.

## Ограничения в отношении белого списка

разрешен только `send_mode == 3`;

В большинстве случаев адреса добавляются в белый список, чтобы позволить пользователю выполнять проверку с помощью заблокированных монет или закладывать заблокированные монеты в пулы.

Чтобы избежать кражи Toncoin, сообщения, которые можно отправлять в белый список, имеют следующие ограничения:

- разрешен только `send_mode == 3`;
- Messages must be bounceable
- не разрешено вложение `state_init`;

System elector addresses accept only these operations:

- `op::elector_new_stake`
- `op::elector_recover_stake`
- `op::vote_for_complaint`
- разрешены операции `op::single_nominator_pool_withdraw`, `op::single_nominator_pool_change_validator`, `op::ton_stakers_deposit`, `op::jetton_burn`, `op::ton_stakers_vote`, `op::vote_for_proposal`, `op::vote_for_complaint`;

Если пункт назначения — адрес системной конфигурации:

- разрешены только операции `op::elector_new_stake`, `op::elector_recover_stake`, `op::vote_for_complaint`, `op::vote_for_proposal`;

Для других пунктов назначения:

- разрешены пустые сообщения и пустые текстовые сообщения;
- разрешены текстовые сообщения, начинающиеся только с "d", "w", "D", "W";
- Specific operations:
  - `op::single_nominator_pool_withdraw`
  - `op::single_nominator_pool_change_validator`
  - `op::ton_stakers_deposit`
  - `op::jetton_burn`
  - `op::ton_stakers_vote`
  - разрешена только операция `op::vote_for_proposal`;
  - `op::vote_for_complaint`

Нет ограничений на адреса, не включенные в белый список. Никаких ограничений не применяется при отправке разблокированных Toncoin, даже если мы отправляем в белый список или `vesting_sender_address`.

## Структура проекта

- `contracts` - исходный код всех смарт-контрактов проекта и их зависимостей.
- `wrappers` - классы-обертки (реализующие `Contract` из ton-core) для контрактов, включая любые примитивы [де]сериализации и функции компиляции.
- `tests` - тесты для контрактов.
- `scripts` - скрипты, используемые проектом, в основном скрипты развертывания.

## Как использовать

### Сборка

```bash
`npx blueprint build` или `yarn blueprint build`.
```

### Тестирование

```bash
`npx blueprint test` или `yarn blueprint test`.
```

### Развертывание или запуск другого скрипта

```bash
`npx blueprint run` или `yarn blueprint run`.
```

### Добавить новый контракт

```bash
`npx blueprint create ContractName` или `yarn blueprint create ContractName`.
```

## См. также

- [Единый номинатор](/v3/documentation/smart-contracts/contracts-specs/single-nominator-pool)
- [vesting-contract](https://github.com/ton-blockchain/vesting-contract)

<Feedback />
