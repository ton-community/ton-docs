import Feedback from '@site/src/components/Feedback';

# Nominator pool

Смарт-контракт _Пул номинаторов_, предоставляет возможность одному или нескольким номинаторам одолжить Toncoin для ставки валидатору и гарантирует, что валидатор может использовать эти Toncoin только для валидации. Кроме того, смарт-контракт гарантирует распределение вознаграждения.

## Архитектура

![image](/img/nominator-pool/nominator-pool.png)

## Ограничения

The pool is designed for large amounts of coins, prioritizing security and code simplicity. Пул не поддерживает малые депозиты или большое количество номинаторов в одном пуле. The target configuration is:

- Minimum nominator stake: 10,000 TON
- Maximum nominators per pool: 40 (untested beyond this limit)

## Fees

In the TON blockchain, the validator cycle is approximately 18 hours, and there are roughly 40.5 validation rounds per month (assuming a 30-day month).

Here's the breakdown of costs based on participation:

- **Participating in only odd or even cycles (half of the rounds):**

  - Rounds per month: ~20.25
  - Cost per round: ~5 Toncoins
  - `total cost = 20.25 * 5 -> ~101.25 Toncoins`

- **Participating in both odd and even cycles (all rounds):**
  - Rounds per month: ~40.5
  - Cost per round : ~ 5 Toncoins
  - `total cost = 40.5 * 5 -> ~202.50 Toncoins`

## Распределение вознаграждений

После завершения раунда проверки пул возвращает свои средства Избирателю. Rewards are split as follows:

```
validator_reward = (reward * validator_reward_share) / 10000;
nominators_reward = reward - validator_reward;
```

Nominators receive shares proportional to their stakes. Например, если в пуле есть два номинатора со ставками 100 000 и 300 000 TON, то первый из них получит 25%, а второй – 75% от `nominators_reward`.

### Slashing

For validation fines:

1. Deduct from validator funds first
2. Если средств валидатора недостаточно, то недостающая сумма будет вычтена у номинаторов пропорционально их ставкам.
3. Pool design ensures validator funds always cover the maximum possible fines

## Validator requirements

The pool participates in validation only when:

- Validator funds exceed `min_validator_stake`
- Validator funds cover maximum possible fines (based on network config)

## Сообщения номинаторов

Чтобы взаимодействовать с пулом номинаторов, номинаторы отправляют простые сообщения с текстовым комментарием (можно отправить из любого приложения кошелька) смарт-контракту пула номинаторов.
**Сообщения должны отправляться в режиме возврата!**

### Депозит номинатора

Send a message with the comment "d" and amount ≥ `min_nominator_stake + 1 TON`.

Deposits:

- Если пул в данный момент не участвует в валидации (`state == 0`), то депозит будет зачислен немедленно.
- Queue as `pending_deposit_amount` if pool active
- Reject if `max_nominators_count` reached

### Withdrawal

Send a message with the comment "w" and 1 TON for fees:

- Executes immediately if funds are available
- Queues as `withdraw_request` otherwise
- Full withdrawal only (no partial withdrawals)

## Validator withdraw

Валидатор может вывести из пула все Toncoin, которые не принадлежат номинаторам.

## Key management

Участники должны хранить свои закрытые ключи

- Lost nominator wallet = lost pool funds
- Lost validator wallet = lost validator funds

:::info
Потеря закрытого ключа кошелька одного участника пула не влияет на других участников.
:::

## Emergency operations

При нормальной работе валидатор должен периодически отправлять в пул номинаторов операционные сообщения, такие как: `process withdraw requests`, `update current validator set`, `new_stake`, `recover_stake`. The validator software `mytonctrl` does this automatically.

## Голосование за предложения по конфигурации сети

В рамках такого голосования валидатор отправляет финальный голос смарт-контракту конфигурации сети через программное обеспечение валидатора.

1. Proposals announced via [@tonblockchain](https://t.me/tonblockchain) or [@tonstatus](https://t.me/tonstatus) with HEX hashes like `D855FFBCF813E50E10BEAB902D1177529CE79785CAE913EB96A72AE8EFBCBF47`
2. Nominators vote by sending a message to the nominator pool:
   - `y<HASH>` to support
   - `n<HASH>` to oppose
     > К этому сообщению должно быть прикреплено некоторое количество Toncoin для оплаты комиссии сети (достаточно 1 TON). Неизрасходованные TON, прикрепленные к сообщению, будут возвращены.
3. Validator submits final vote based on pool consensus
4. Голоса хранятся в контракте пула в течение 30 дней.

## Get methods

#### GET-метод `get_pool_data`

Returns complete pool state information as a tuple containing:

1. state – uint – текущее состояние пула номинаторов. 0 – не участвует в валидации, 1 – отправил запрос `new_stake` на участие в раунде валидации, 2 – получил успешное подтверждение об участии в раунде валидации.

2. nominators_count – uint – текущее количество номинаторов в пуле.

3. `stake_amount_sent` (nanotons)\
   The current validation stake amount

4. validator_amount – nanotons – количество монет, принадлежащих валидатору.

5. validator_address – immutable – uint – адрес кошелька валидатора. Чтобы получить адрес, выполните `"-1:" + dec_to_hex(validator_address)`.

6. `validator_reward_share` (uint, immutable)\
   Validator's reward percentage. Например, установите 4000, чтобы получить 40%.

```
Валидатор получает часть вознаграждения в соответствии с неизменяемым параметром пула `validator_reward_share`.
```

7. max_nominators_count – immutable – uint – максимальное количество номинаторов в этом пуле.

8. min_validator_stake – immutable – nanotons – минимальная ставка валидатора в этом пуле.

9. min_nominator_stake – immutable – nanotons – минимальная ставка для номинатора в этом пуле.

10. nominators – cell – необработанный словарь с номинаторами.

11. withdraw_requests – cell – необработанный словарь с запросами на вывод средств от номинаторов.

12. `stake_at` (uint)\
    Next validation round ID, which is supposed to start at [`utime_since`](/v3/documentation/network/configs/blockchain-configs#configuration-parameters-4)

13. saved_validator_set_hash - uint - техническая информация.

14. validator_set_changes_count - uint - техническая информация.

15. validator_set_change_time - uint - техническая информация.

16. `stake_held_for` (uint)\
    Stake lock duration

17. config_proposal_votings – cell – необработанный справочник, содержащий конфигурации предложений голосования.

#### GET-метод `list_nominators`

Returns an array of all nominators with their:

1. address – uint – адрес кошелька номинатора. Чтобы получить адрес, выполните `"0:" + dec_to_hex(address)`.
2. `amount` (nanotons)\
   Active stake balance
3. `pending_deposit_amount` (nanotons)\
   Queued deposit amount
4. withdraw_request – int – если `-1`, то этот номинатор отправил запрос на вывод всех своих средств.

#### GET-метод `get_nominator_data`

Returns detailed nominator information for the specified address.

> Address must be in raw format without the `0:` prefix.

1. количество – nanotons – текущая активная ставка номинатора.
2. количество – nanotons – текущая активная ставка номинатора.
3. withdraw_request – int – если `-1`, то этот номинатор отправил запрос на вывод всех своих средств.

Если в пуле нет такого номинатора, то метод выдаст ошибку `86`.

**Example**:\
For nominator `EQA0i8-CdGnF_DhUHHf92R1ONH6sIA9vLZ_WLcCIhfBBXwtG`:

```bash
get_nominator_data 0x348bcf827469c5fc38541c77fdd91d4e347eac200f6f2d9fd62dc08885f0415f
```

### Голосование номинатора

#### GET-метод `list_votes`

Returns all active proposals with the following:

1. proposal_hash – uint – хэш предложения. Используйте `dec_to_hex(proposal_hash)` для преобразования хэша в HEX-форму.
2. votes_create_time - uint - время создания этого голосования.

#### GET-метод `list_voters`

Returns voting details per proposal:

1. `address` (uint)
   - Nominator: `"0:" + dec_to_hex(address)`
   - Чтобы получить адрес номинатора, выполните `"0:" + dec_to_hex(address)`, если `address = validator_address`, сделайте `"-1:" + dec_to_hex(address)`.
2. `support` (int)
   - `-1` = For
   - `0` = Against
3. vote_time – uint – единичное время, когда он проголосовал.

Результаты голосования подсчитываются off-chain.

## Интеграция в приложения для кошельков

Для депозитов, снятия денег и голосования отправьте пулу простые сообщения с нужными текстовыми комментариями, как описано выше. При отправке депозита вы можете сохранить сумму, которая была отправлена, в локальном хранилище. При отправке повторного депозита также добавьте его к этой сумме.

Чтобы узнать текущую прибыль, вызовите метод `get_nominator_data(your_address)`.

```python
Прибыль будет равна (`amount + pending_deposit_amount – sent_amount_stored_in_local_storage`).
```

Чтобы получить информацию о пуле, вызовите get-методы `get_pool_data` и `list_nominators`.

## См. также

- [Контракт с пулом номинаторов](https://github.com/ton-blockchain/nominator-pool)
- [Как использовать пул номинаторов](/v3/guidelines/smart-contracts/howto/nominator-pool)

<Feedback />
