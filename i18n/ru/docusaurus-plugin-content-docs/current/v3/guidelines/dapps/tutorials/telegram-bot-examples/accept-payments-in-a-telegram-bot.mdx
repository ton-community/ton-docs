---
description: –í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ –º—ã —Ä–∞—Å—Å–∫–∞–∂–µ–º –æ —Ç–æ–º, –∫–∞–∫ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –ø–ª–∞—Ç–µ–∂–∏ –≤ –±–æ—Ç–µ Telegram.
---

# –ë–æ—Ç-–≤–∏—Ç—Ä–∏–Ω–∞ –º–∞–≥–∞–∑–∏–Ω–∞ —Å –æ–ø–ª–∞—Ç–æ–π –≤ TON

:::warning
–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–∞ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ–º –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫, –Ω–æ –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤ —É–ª—É—á—à–µ–Ω–∏—è—Ö. –ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø—Ä–∏–Ω—è—Ç—å —É—á–∞—Å—Ç–∏–µ –≤ –ø–µ—Ä–µ–≤–æ–¥–µ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å [@alexgton](https://t.me/alexgton).
:::

–í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ –º—ã —Ä–∞—Å—Å–∫–∞–∂–µ–º –æ —Ç–æ–º, –∫–∞–∫ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –ø–ª–∞—Ç–µ–∂–∏ –≤ –±–æ—Ç–µ Telegram.

## üìñ –ß–µ–º—É –≤—ã –Ω–∞—É—á–∏—Ç–µ—Å—å

–í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ –≤—ã —É–∑–Ω–∞–µ—Ç–µ, –∫–∞–∫:

- —Å–æ–∑–¥–∞—Ç—å Telegram-–±–æ—Ç–∞ —Å –ø–æ–º–æ—â—å—é Python + Aiogram
- —Ä–∞–±–æ—Ç–∞—Ç—å —Å –ø—É–±–ª–∏—á–Ω—ã–º API TON (TON Center)
- —Ä–∞–±–æ—Ç–∞—Ç—å —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö SQlite

–ò –Ω–∞–∫–æ–Ω–µ—Ü: –∫–∞–∫ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –ø–ª–∞—Ç–µ–∂–∏ –≤ Telegram-–±–æ—Ç–µ, –∏—Å–ø–æ–ª—å–∑—É—è –∑–Ω–∞–Ω–∏—è –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —à–∞–≥–æ–≤.

## üìö –ü—Ä–µ–∂–¥–µ —á–µ–º –º—ã –Ω–∞—á–Ω–µ–º

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è Python –∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –ø–∞–∫–µ—Ç—ã:

- aiogram
- requests
- sqlite3

## üöÄ –î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω–µ–º!

–ú—ã –±—É–¥–µ–º –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –ø–æ –Ω–∏–∂–µ–ø—Ä–∏–≤–µ–¥–µ–Ω–Ω–æ–º—É –ø–æ—Ä—è–¥–∫—É:

1. –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö SQlite
2. –†–∞–±–æ—Ç–∞ —Å –ø—É–±–ª–∏—á–Ω—ã–º API TON (TON Center)
3. –°–æ–∑–¥–∞–Ω–∏–µ Telegram-–±–æ—Ç–∞ —Å –ø–æ–º–æ—â—å—é Python + Aiogram
4. –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∏–±—ã–ª—å!

–î–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º —Å–ª–µ–¥—É—é—â–∏–µ —á–µ—Ç—ã—Ä–µ —Ñ–∞–π–ª–∞ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –Ω–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞:

```
telegram-bot
‚îú‚îÄ‚îÄ config.json
‚îú‚îÄ‚îÄ main.py
‚îú‚îÄ‚îÄ api.py
‚îî‚îÄ‚îÄ db.py
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–í `config.json` –º—ã —Å–æ—Ö—Ä–∞–Ω–∏–º —Ç–æ–∫–µ–Ω –Ω–∞—à–µ–≥–æ –±–æ—Ç–∞ –∏ –Ω–∞—à –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á TON API.

```json
{
  "BOT_TOKEN": "Your bot token",
  "MAINNET_API_TOKEN": "Your mainnet api token",
  "TESTNET_API_TOKEN": "Your testnet api token",
  "MAINNET_WALLET": "Your mainnet wallet",
  "TESTNET_WALLET": "Your testnet wallet",
  "WORK_MODE": "testnet"
}
```

–í `config.json` –º—ã —Ä–µ—à–∞–µ–º, –∫–∞–∫—É—é —Å–µ—Ç—å –º—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å: `testnet` –∏–ª–∏ `mainnet`.

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –°–æ–∑–¥–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

–í —ç—Ç–æ–º –ø—Ä–∏–º–µ—Ä–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö Sqlite.

–°–æ–∑–¥–∞–π—Ç–µ `db.py`.

–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö, –Ω–∞–º –Ω—É–∂–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥—É–ª—å sqlite3
–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–æ–¥—É–ª–µ–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º.

```python
import sqlite3
import datetime
import pytz
```

- `Sqlite3`-–º–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö sqlite
- `datetime` - –º–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º
- `pytz`- –º–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —á–∞—Å–æ–≤—ã–º–∏ –ø–æ—è—Å–∞–º–∏

–î–∞–ª–µ–µ –Ω–∞–º –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∏ –∫—É—Ä—Å–æ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–µ–π:

```python
locCon = sqlite3.connect('local.db', check_same_thread=False)
cur = locCon.cursor()
```

–ï—Å–ª–∏ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ–Ω–∞ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

–¢–µ–ø–µ—Ä—å –º—ã –º–æ–∂–µ–º —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã. –£ –Ω–∞—Å –∏—Ö –¥–≤–µ.

#### –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:

```sql
CREATE TABLE transactions (
    source  VARCHAR (48) NOT NULL,
    hash    VARCHAR (50) UNIQUE
                         NOT NULL,
    value   INTEGER      NOT NULL,
    comment VARCHAR (50)
);
```

- `source` - –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞ –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞
- `hash`- —Ö—ç—à —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- `value`- –∑–Ω–∞—á–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- `comment`- –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

#### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:

```sql
CREATE TABLE users (
    id         INTEGER       UNIQUE
                             NOT NULL,
    username   VARCHAR (33),
    first_name VARCHAR (300),
    wallet     VARCHAR (50)  DEFAULT none
);
```

- `id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram
- `username` - –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram
- `first_name` - –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram
- `wallet`- –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–í —Ç–∞–±–ª–∏—Ü–µ `users` –º—ã —Ö—Ä–∞–Ω–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π :) –∏—Ö Telegram ID, @–ª–æ–≥–∏–Ω,
–∏–º—è –∏ –∫–æ—à–µ–ª–µ–∫. –ö–æ—à–µ–ª–µ–∫ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–µ—Ä–≤–æ–º
—É—Å–ø–µ—à–Ω–æ–º –ø–ª–∞—Ç–µ–∂–µ.

–í —Ç–∞–±–ª–∏—Ü–µ `transactions` —Ö—Ä–∞–Ω—è—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
–ß—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é, –Ω–∞–º –Ω—É–∂–Ω—ã —Ö–µ—à, –∏—Å—Ç–æ—á–Ω–∏–∫, –∑–Ω–∞—á–µ–Ω–∏–µ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.

–ß—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å —ç—Ç–∏ —Ç–∞–±–ª–∏—Ü—ã, –Ω–∞–º –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å–ª–µ–¥—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é:

```python
cur.execute('''CREATE TABLE IF NOT EXISTS transactions (
    source  VARCHAR (48) NOT NULL,
    hash    VARCHAR (50) UNIQUE
                        NOT NULL,
    value   INTEGER      NOT NULL,
    comment VARCHAR (50)
)''')
locCon.commit()

cur.execute('''CREATE TABLE IF NOT EXISTS users (
    id         INTEGER       UNIQUE
                            NOT NULL,
    username   VARCHAR (33),
    first_name VARCHAR (300),
    wallet     VARCHAR (50)  DEFAULT none
)''')
locCon.commit()
```

–≠—Ç–æ—Ç –∫–æ–¥ —Å–æ–∑–¥–∞—Å—Ç —Ç–∞–±–ª–∏—Ü—ã, –µ—Å–ª–∏ –æ–Ω–∏ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã.

### –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö

–î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∏—Ç—É–∞—Ü–∏—é.
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–≤–µ—Ä—à–∏–ª —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é. –ö–∞–∫ –µ–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å? –ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å —Ç–∞–∫, —á—Ç–æ–±—ã –æ–¥–Ω–∞ –∏ —Ç–∞ –∂–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ –±—ã–ª–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ –¥–≤–∞–∂–¥—ã?

–í —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö –µ—Å—Ç—å body_hash, —Å –ø–æ–º–æ—â—å—é –∫–æ—Ç–æ—Ä–æ–≥–æ –º—ã –º–æ–∂–µ–º –ª–µ–≥–∫–æ –ø–æ–Ω—è—Ç—å, –µ—Å—Ç—å –ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –Ω–µ—Ç.

–ú—ã –¥–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –º—ã —É–≤–µ—Ä–µ–Ω—ã. –§—É–Ω–∫—Ü–∏—è `check_transaction` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ –Ω–∞–π–¥–µ–Ω–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –Ω–µ—Ç.

`add_v_transaction` –¥–æ–±–∞–≤–ª—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ —Ç–∞–±–ª–∏—Ü—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.

```python
def add_v_transaction(source, hash, value, comment):
    cur.execute("INSERT INTO transactions (source, hash, value, comment) VALUES (?, ?, ?, ?)",
                (source, hash, value, comment))
    locCon.commit()
```

```python
def check_transaction(hash):
    cur.execute(f"SELECT hash FROM transactions WHERE hash = '{hash}'")
    result = cur.fetchone()
    if result:
        return True
    return False
```

`check_user` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –µ–≥–æ, –µ—Å–ª–∏ –Ω–µ—Ç.

```python
def check_user(user_id, username, first_name):
    cur.execute(f"SELECT id FROM users WHERE id = '{user_id}'")
    result = cur.fetchone()

    if not result:
        cur.execute("INSERT INTO users (id, username, first_name) VALUES (?, ?, ?)",
                    (user_id, username, first_name))
        locCon.commit()
        return False
    return True
```

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ—à–µ–ª–µ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ. –û–Ω –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–π —É—Å–ø–µ—à–Ω–æ–π –ø–æ–∫—É–ø–∫–µ. –§—É–Ω–∫—Ü–∏—è `v_wallet` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –Ω–∏–º –∫–æ—à–µ–ª–µ–∫. –ï—Å–ª–∏ –µ—Å—Ç—å, —Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ–≥–æ. –ï—Å–ª–∏ –Ω–µ—Ç, —Ç–æ –¥–æ–±–∞–≤–ª—è–µ—Ç.

```python
def v_wallet(user_id, wallet):
    cur.execute(f"SELECT wallet FROM users WHERE id = '{user_id}'")
    result = cur.fetchone()
    if result[0] == "none":
        cur.execute(
            f"UPDATE users SET wallet = '{wallet}' WHERE id = '{user_id}'")
        locCon.commit()
        return True
    else:
        return result[0]
```

`get_user_wallet` –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—à–µ–ª–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

```python
def get_user_wallet(user_id):
    cur.execute(f"SELECT wallet FROM users WHERE id = '{user_id}'")
    result = cur.fetchone()
    return result[0]
```

`get_user_payments` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–æ—à–µ–ª–µ–∫. –ï—Å–ª–∏ –µ—Å—Ç—å, —Ç–æ –æ–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø–ª–∞—Ç–µ–∂–µ–π.

```python
def get_user_payments(user_id):
    wallet = get_user_wallet(user_id)

    if wallet == "none":
        return "You have no wallet"
    else:
        cur.execute(f"SELECT * FROM transactions WHERE source = '{wallet}'")
        result = cur.fetchall()
        tdict = {}
        tlist = []
        try:
            for transaction in result:
                tdict = {
                    "value": transaction[2],
                    "comment": transaction[3],
                }
                tlist.append(tdict)
            return tlist

        except:
            return False
```

## API

*–£ –Ω–∞—Å –µ—Å—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å –±–ª–æ–∫—á–µ–π–Ω–æ–º, –∏—Å–ø–æ–ª—å–∑—É—è —Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ API, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º—ã–µ –Ω–µ–∫–æ—Ç–æ—Ä—ã–º–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ —Å–µ—Ç–∏. –° –ø–æ–º–æ—â—å—é —ç—Ç–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–≥—É—Ç –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —ç—Ç–∞–ø –∑–∞–ø—É—Å–∫–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —É–∑–ª–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ API.*

### –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã

–§–∞–∫—Ç–∏—á–µ—Å–∫–∏, —á—Ç–æ –Ω–∞–º –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–≤–µ–ª –Ω–∞–º —Ç—Ä–µ–±—É–µ–º—É—é —Å—É–º–º—É?

–ù–∞–º –ø—Ä–æ—Å—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≤—Ö–æ–¥—è—â–∏–µ –ø–µ—Ä–µ–≤–æ–¥—ã –Ω–∞ –Ω–∞—à –∫–æ—à–µ–ª–µ–∫ –∏ –Ω–∞–π—Ç–∏ —Å—Ä–µ–¥–∏ –Ω–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —Å –Ω—É–∂–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞ —Å –Ω—É–∂–Ω–æ–π —Å—É–º–º–æ–π (–∏, –≤–æ–∑–º–æ–∂–Ω–æ, —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º).
–î–ª—è –≤—Å–µ–≥–æ —ç—Ç–æ–≥–æ –≤ TON Center –µ—Å—Ç—å –º–µ—Ç–æ–¥ `getTransactions`.

### getTransactions

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –º—ã –ø—Ä–∏–º–µ–Ω–∏–º —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é, –º—ã –ø–æ–ª—É—á–∏–º 10 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π. –û–¥–Ω–∞–∫–æ –º—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ–º —É–∫–∞–∑–∞—Ç—å, —á—Ç–æ –Ω–∞–º –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ, –Ω–æ —ç—Ç–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —É–≤–µ–ª–∏—á–∏—Ç –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞. –ò, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –≤–∞–º –Ω–µ –Ω—É–∂–Ω–æ —Ç–∞–∫ –º–Ω–æ–≥–æ.

–ï—Å–ª–∏ –≤–∞–º –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ, —Ç–æ —É –∫–∞–∂–¥–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –µ—Å—Ç—å `lt` –∏ `hash`. –í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å, –Ω–∞–ø—Ä–∏–º–µ—Ä, 30 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, –∏ –µ—Å–ª–∏ —Å—Ä–µ–¥–∏ –Ω–∏—Ö –Ω–µ –Ω–∞–π–¥–µ—Ç—Å—è –Ω—É–∂–Ω–æ–π, —Ç–æ –≤–∑—è—Ç—å `lt` –∏ `hash` –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∏ –¥–æ–±–∞–≤–∏—Ç—å –∏—Ö –≤ –∑–∞–ø—Ä–æ—Å.

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ 30 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ.

–ù–∞–ø—Ä–∏–º–µ—Ä, –≤ —Ç–µ—Å—Ç–æ–≤–æ–π —Å–µ—Ç–∏ –µ—Å—Ç—å –∫–æ—à–µ–ª–µ–∫ `EQAVKMzqtrvNB2SkcBONOijadqFZ1gMdjmzh1Y3HB1p_zai5`, –≤ –Ω–µ–º –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:

–ò—Å–ø–æ–ª—å–∑—É—è –∑–∞–ø—Ä–æ—Å, –º—ã –ø–æ–ª—É—á–∏–º –æ—Ç–≤–µ—Ç, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –¥–≤–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (—á–∞—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä–∞—è —Å–µ–π—á–∞—Å –Ω–µ –Ω—É–∂–Ω–∞, –±—ã–ª–∞ —Å–∫—Ä—ã—Ç–∞, –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –≤—ã –º–æ–∂–µ—Ç–µ —É–≤–∏–¥–µ—Ç—å –ø–æ —Å—Å—ã–ª–∫–µ –≤—ã—à–µ).

```json
{
  "ok": true,
  "result": [
    {
      "transaction_id": {
        // highlight-next-line
        "lt": "1944556000003",
        // highlight-next-line
        "hash": "swpaG6pTBXwYI2024NAisIFp59Fw3k1DRQ5fa5SuKAE="
      },
      "in_msg": {
        "source": "EQCzQJJBAQ-FrEFcvxO5sNxhV9CaOdK9CCfq2yCBnwZ4aJ9R",
        "destination": "EQAVKMzqtrvNB2SkcBONOijadqFZ1gMdjmzh1Y3HB1p_zai5",
        "value": "1000000000",
        "body_hash": "kBfGYBTkBaooeZ+NTVR0EiVGSybxQdb/ifXCRX5O7e0=",
        "message": "Sea breeze üåä"
      },
      "out_msgs": []
    },
    {
      "transaction_id": {
        // highlight-next-line
        "lt": "1943166000003",
        // highlight-next-line
        "hash": "hxIQqn7lYD/c/fNS7W/iVsg2kx0p/kNIGF6Ld0QEIxk="
      },
      "in_msg": {
        "source": "EQCzQJJBAQ-FrEFcvxO5sNxhV9CaOdK9CCfq2yCBnwZ4aJ9R",
        "destination": "EQAVKMzqtrvNB2SkcBONOijadqFZ1gMdjmzh1Y3HB1p_zai5",
        "value": "1000000000",
        "body_hash": "7iirXn1RtliLnBUGC5umIQ6KTw1qmPk+wwJ5ibh9Pf0=",
        "message": "Spring forest üå≤"
      },
      "out_msgs": []
    }
  ]
}
```

–ú—ã –ø–æ–ª—É—á–∏–ª–∏ –¥–≤–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å —ç—Ç–æ–≥–æ –∞–¥—Ä–µ—Å–∞. –î–æ–±–∞–≤–∏–≤ –≤ –∑–∞–ø—Ä–æ—Å `lt` –∏ `hash`, –º—ã —Å–Ω–æ–≤–∞ –ø–æ–ª—É—á–∏–º –¥–≤–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏. –û–¥–Ω–∞–∫–æ –≤—Ç–æ—Ä–∞—è —Å—Ç–∞–Ω–µ—Ç —Å–ª–µ–¥—É—é—â–µ–π –≤ —Ä—è–¥—É. –¢–æ –µ—Å—Ç—å, –º—ã –ø–æ–ª—É—á–∏–º –≤—Ç–æ—Ä—É—é –∏ —Ç—Ä–µ—Ç—å—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è —ç—Ç–æ–≥–æ –∞–¥—Ä–µ—Å–∞.

```json
{
  "ok": true,
  "result": [
    {
      "transaction_id": {
        "lt": "1943166000003",
        "hash": "hxIQqn7lYD/c/fNS7W/iVsg2kx0p/kNIGF6Ld0QEIxk="
      },
      "in_msg": {
        "source": "EQCzQJJBAQ-FrEFcvxO5sNxhV9CaOdK9CCfq2yCBnwZ4aJ9R",
        "destination": "EQAVKMzqtrvNB2SkcBONOijadqFZ1gMdjmzh1Y3HB1p_zai5",
        "value": "1000000000",
        "body_hash": "7iirXn1RtliLnBUGC5umIQ6KTw1qmPk+wwJ5ibh9Pf0=",
        "message": "Spring forest üå≤"
      },
      "out_msgs": []
    },
    {
      "transaction_id": {
        "lt": "1845458000003",
        "hash": "k5U9AwIRNGhC10hHJ3MBOPT//bxAgW5d9flFiwr1Sao="
      },
      "in_msg": {
        "source": "EQCzQJJBAQ-FrEFcvxO5sNxhV9CaOdK9CCfq2yCBnwZ4aJ9R",
        "destination": "EQAVKMzqtrvNB2SkcBONOijadqFZ1gMdjmzh1Y3HB1p_zai5",
        "value": "1000000000",
        "body_hash": "XpTXquHXP64qN6ihHe7Tokkpy88tiL+5DeqIrvrNCyo=",
        "message": "Second"
      },
      "out_msgs": []
    }
  ]
}
```

–ó–∞–ø—Ä–æ—Å –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å [–≤–æ—Ç —Ç–∞–∫](https://testnet.toncenter.com/api/v2/getTransactions?address=EQAVKMzqtrvNB2SkcBONOijadqFZ1gMdjmzh1Y3HB1p_zai5\&limit=2\&lt=1943166000003\&hash=hxIQqn7lYD%2Fc%2FfNS7W%2FiVsg2kx0p%2FkNIGF6Ld0QEIxk%3D\&to_lt=0\&archival=true)

–ù–∞–º —Ç–∞–∫–∂–µ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –º–µ—Ç–æ–¥ `detectAddress`.

–í–æ—Ç –ø—Ä–∏–º–µ—Ä –∞–¥—Ä–µ—Å–∞ –∫–æ—à–µ–ª—å–∫–∞ Tonkeeper –≤ —Ç–µ—Å—Ç–æ–≤–æ–π —Å–µ—Ç–∏: `kQCzQJJBAQ-FrEFcvxO5sNxhV9CaOdK9CCfq2yCBnwZ4aCTb`. –ï—Å–ª–∏ –º—ã –ø–æ–∏—â–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ –ø—Ä–æ–≤–æ–¥–Ω–∏–∫–µ, —Ç–æ –≤–º–µ—Å—Ç–æ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≤—ã—à–µ –∞–¥—Ä–µ—Å–∞ –±—É–¥–µ—Ç: `EQCzQJJBAQ-FrEFcvxO5sNxhV9CaOdK9CCfq2yCBnwZ4aJ9R`.

–≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞–º "–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π" –∞–¥—Ä–µ—Å.

```json
{
  "ok": true,
  "result": {
    "raw_form": "0:b3409241010f85ac415cbf13b9b0dc6157d09a39d2bd0827eadb20819f067868",
    "bounceable": {
      "b64": "EQCzQJJBAQ+FrEFcvxO5sNxhV9CaOdK9CCfq2yCBnwZ4aJ9R",
      // highlight-next-line
      "b64url": "EQCzQJJBAQ-FrEFcvxO5sNxhV9CaOdK9CCfq2yCBnwZ4aJ9R"
    },
    "non_bounceable": {
      "b64": "UQCzQJJBAQ+FrEFcvxO5sNxhV9CaOdK9CCfq2yCBnwZ4aMKU",
      "b64url": "UQCzQJJBAQ-FrEFcvxO5sNxhV9CaOdK9CCfq2yCBnwZ4aMKU"
    }
  }
}
```

–ù–∞–º –Ω—É–∂–µ–Ω `b64url`.

–≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞–º –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∞–¥—Ä–µ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–ü–æ –±–æ–ª—å—à–µ–π —á–∞—Å—Ç–∏, —ç—Ç–æ –≤—Å–µ, —á—Ç–æ –Ω–∞–º –Ω—É–∂–Ω–æ.

### –ó–∞–ø—Ä–æ—Å—ã API –∏ —á—Ç–æ —Å –Ω–∏–º–∏ –¥–µ–ª–∞—Ç—å

–î–∞–≤–∞–π—Ç–µ –≤–µ—Ä–Ω–µ–º—Å—è –≤ IDE. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `api.py`.

–ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏.

```python
import requests
import json
# We import our db module, as it will be convenient to add from here
# transactions to the database
import db
```

- `requests` - –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ API
- `json` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å json
- `db` - –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–∞—à–µ–π –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö sqlite

–î–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º –¥–≤–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—á–∞–ª–∞ –∑–∞–ø—Ä–æ—Å–æ–≤.

```python
# This is the beginning of our requests
MAINNET_API_BASE = "https://toncenter.com/api/v2/"
TESTNET_API_BASE = "https://testnet.toncenter.com/api/v2/"
```

–ü–æ–ª—É—á–∏—Ç–µ –≤—Å–µ API-—Ç–æ–∫–µ–Ω—ã –∏ –∫–æ—à–µ–ª—å–∫–∏ –∏–∑ —Ñ–∞–π–ª–∞ config.json.

```python
# Find out which network we are working on
with open('config.json', 'r') as f:
    config_json = json.load(f)
    MAINNET_API_TOKEN = config_json['MAINNET_API_TOKEN']
    TESTNET_API_TOKEN = config_json['TESTNET_API_TOKEN']
    MAINNET_WALLET = config_json['MAINNET_WALLET']
    TESTNET_WALLET = config_json['TESTNET_WALLET']
    WORK_MODE = config_json['WORK_MODE']
```

–í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–µ—Ç–∏, –º—ã –±–µ—Ä–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ.

```python
if WORK_MODE == "mainnet":
    API_BASE = MAINNET_API_BASE
    API_TOKEN = MAINNET_API_TOKEN
    WALLET = MAINNET_WALLET
else:
    API_BASE = TESTNET_API_BASE
    API_TOKEN = TESTNET_API_TOKEN
    WALLET = TESTNET_WALLET
```

–ù–∞—à–∞ –ø–µ—Ä–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ `detectAddress`.

```python
def detect_address(address):
    url = f"{API_BASE}detectAddress?address={address}&api_key={API_TOKEN}"
    r = requests.get(url)
    response = json.loads(r.text)
    try:
        return response['result']['bounceable']['b64url']
    except:
        return False
```

–ù–∞ –≤—Ö–æ–¥–µ –º—ã –∏–º–µ–µ–º –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã–π –∞–¥—Ä–µ—Å, –∞ –Ω–∞ –≤—ã—Ö–æ–¥–µ - –ª–∏–±–æ "correct" –∞–¥—Ä–µ—Å, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π –Ω–∞–º –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ä–∞–±–æ—Ç—ã, –ª–∏–±–æ False.

–í—ã –º–æ–∂–µ—Ç–µ –∑–∞–º–µ—Ç–∏—Ç—å, —á—Ç–æ –≤ –∫–æ–Ω—Ü–µ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ—è–≤–∏–ª—Å—è API-–∫–ª—é—á. –û–Ω –Ω—É–∂–µ–Ω –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã —Å–Ω—è—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API. –ë–µ–∑ –Ω–µ–≥–æ –º—ã –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º –≤ —Å–µ–∫—É–Ω–¥—É.

–í–æ—Ç —Å–ª–µ–¥—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è `getTransactions`:

```python
def get_address_transactions():
    url = f"{API_BASE}getTransactions?address={WALLET}&limit=30&archival=true&api_key={API_TOKEN}"
    r = requests.get(url)
    response = json.loads(r.text)
    return response['result']
```

–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ –Ω–∞—à `WALLET`.

–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ —É–≤–∏–¥–µ—Ç—å `archival=true`. –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –º—ã –ø—Ä–∏–Ω–∏–º–∞–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Ç–æ–ª—å–∫–æ –æ—Ç —É–∑–ª–∞ —Å –ø–æ–ª–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–µ–π –±–ª–æ–∫—á–µ–π–Ω–∞.

–ù–∞ –≤—ã—Ö–æ–¥–µ –º—ã –ø–æ–ª—É—á–∏–º —Å–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π -[{0},{1},...,{29}]. –î—Ä—É–≥–∏–º–∏ —Å–ª–æ–≤–∞–º–∏, —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π.

–ò, –Ω–∞–∫–æ–Ω–µ—Ü, –ø–æ—Å–ª–µ–¥–Ω—è—è —Ñ—É–Ω–∫—Ü–∏—è:

```python
def find_transaction(user_wallet, value, comment):
		# Get the last 30 transactions
    transactions = get_address_transactions()
    for transaction in transactions:
				# Select the incoming "message" - transaction
        msg = transaction['in_msg']
        if msg['source'] == user_wallet and msg['value'] == value and msg['message'] == comment:
						# If all the data match, we check that this transaction
						# we have not verified before
            t = db.check_transaction(msg['body_hash'])
            if t == False:
								# If not, we write in the table to the verified
								# and return True
                db.add_v_transaction(
                    msg['source'], msg['body_hash'], msg['value'], msg['message'])
                print("find transaction")
                print(
                    f"transaction from: {msg['source']} \nValue: {msg['value']} \nComment: {msg['message']}")
                return True
						# If this transaction is already verified, we check the rest, we can find the right one
            else:
                pass
		# If the last 30 transactions do not contain the required one, return False
		# Here you can add code to see the next 29 transactions
		# However, within the scope of the Example, this would be redundant.
    return False
```

–ù–∞ –≤—Ö–æ–¥ –ø–æ–¥–∞—é—Ç—Å—è "correct" –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞, —Å—É–º–º–∞ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π. –ï—Å–ª–∏ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–∞—è –≤—Ö–æ–¥—è—â–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–∞–π–¥–µ–Ω–∞, —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –±—É–¥–µ—Ç True; –≤ –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ - False.

## Telegram-–±–æ—Ç

–í–æ-–ø–µ—Ä–≤—ã—Ö, –¥–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º –æ—Å–Ω–æ–≤—É –¥–ª—è –±–æ—Ç–∞.

### –ò–º–ø–æ—Ä—Ç

–í —ç—Ç–æ–π —á–∞—Å—Ç–∏ –º—ã –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏.

–ò–∑ `aiogram` –Ω–∞–º –Ω—É–∂–Ω—ã `Bot`, `Dispatcher`, `types` –∏ `executor`.

```python
from aiogram import Bot, Dispatcher, executor, types
```

`MemoryStorage` –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.

`FSMContext`, `State` –∏ `StatesGroup` –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–∞—à–∏–Ω–æ–π —Å–æ—Å—Ç–æ—è–Ω–∏–π.

```python
from aiogram.contrib.fsm_storage.memory import MemoryStorage
from aiogram.dispatcher import FSMContext
from aiogram.dispatcher.filters.state import State, StatesGroup
```

`json` –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å json-—Ñ–∞–π–ª–∞–º–∏. `logging` –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ—à–∏–±–æ–∫.

```python
import json
import logging
```

`api` –∏ `db` - —ç—Ç–æ –Ω–∞—à–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –∑–∞–ø–æ–ª–Ω–∏–º –ø–æ–∑–∂–µ.

```python
import db
import api
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

–î–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ö—Ä–∞–Ω–∏—Ç—å —Ç–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ, –∫–∞–∫ `BOT_TOKEN` –∏ –≤–∞—à–∏ –∫–æ—à–µ–ª—å–∫–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π, –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ –ø–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º `config.json`.

```json
{
  "BOT_TOKEN": "Your bot token",
  "MAINNET_API_TOKEN": "Your mainnet api token",
  "TESTNET_API_TOKEN": "Your testnet api token",
  "MAINNET_WALLET": "Your mainnet wallet",
  "TESTNET_WALLET": "Your testnet wallet",
  "WORK_MODE": "testnet"
}
```

#### –¢–æ–∫–µ–Ω –±–æ—Ç–∞

`BOT_TOKEN` - —ç—Ç–æ —Ç–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ Telegram-–±–æ—Ç–∞ –æ—Ç [@BotFather](https://t.me/BotFather)

#### –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã

–í –∫–ª—é—á–µ `WORK_MODE` –º—ã –æ–ø—Ä–µ–¥–µ–ª–∏–º —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞ - —Ç–µ—Å—Ç–æ–≤–∞—è –∏–ª–∏ –æ—Å–Ω–æ–≤–Ω–∞—è —Å–µ—Ç—å; `testnet` –∏–ª–∏ `mainnet` —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ.

#### API-—Ç–æ–∫–µ–Ω—ã

API-—Ç–æ–∫–µ–Ω—ã –¥–ª—è `*_API_TOKEN` –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –≤ –±–æ—Ç–∞—Ö [TON Center](https://toncenter.com/):

- –¥–ª—è mainnet - [@tonapibot](https://t.me/tonapibot)
- –¥–ª—è testnet - [@tontestnetapibot](https://t.me/tontestnetapibot)

#### –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∫ –±–æ—Ç—É

–î–∞–ª–µ–µ –º—ã –∑–∞–∫–æ–Ω—á–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É –±–æ—Ç–∞.

–ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞ –∏–∑ `config.json` :

```python
with open('config.json', 'r') as f:
    config_json = json.load(f)
    # highlight-next-line
    BOT_TOKEN = config_json['BOT_TOKEN']
		# put wallets here to receive payments
    MAINNET_WALLET = config_json['MAINNET_WALLET']
    TESTNET_WALLET = config_json['TESTNET_WALLET']
    WORK_MODE = config_json['WORK_MODE']

if WORK_MODE == "mainnet":
    WALLET = MAINNET_WALLET
else:
		# By default, the bot will run on the testnet
    WALLET = TESTNET_WALLET
```

### –í–µ–¥–µ–Ω–∏–µ –∂—É—Ä–Ω–∞–ª–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ—Ç–∞

```python
logging.basicConfig(level=logging.INFO)
bot = Bot(token=BOT_TOKEN, parse_mode=types.ParseMode.HTML)
dp = Dispatcher(bot, storage=MemoryStorage())
```

### –°–æ—Å—Ç–æ—è–Ω–∏—è

–ù–∞–º –Ω—É–∂–Ω—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è, —á—Ç–æ–±—ã —Ä–∞–∑–¥–µ–ª–∏—Ç—å —Ä–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å –±–æ—Ç–∞ –Ω–∞ —ç—Ç–∞–ø—ã. –ú—ã –º–æ–∂–µ–º —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—ã–π —ç—Ç–∞–ø –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –∑–∞–¥–∞—á–∏.

```python
class DataInput (StatesGroup):
    firstState = State()
    secondState = State()
    WalletState = State()
    PayState = State()
```

–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–∏–º–µ—Ä—ã —Å–º–æ—Ç—Ä–∏—Ç–µ –≤ [–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ Aiogram](https://docs.aiogram.dev/en/latest/).

### –•–µ–Ω–¥–ª–µ—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π

–í —ç—Ç–æ–π —á–∞—Å—Ç–∏ –º—ã –Ω–∞–ø–∏—à–µ–º –ª–æ–≥–∏–∫—É –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –±–æ—Ç–æ–º.

–ú—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–≤–∞ —Ç–∏–ø–∞ —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤:

- `message_handler` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- `callback_query_handler` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ callback –æ—Ç –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä.

–ï—Å–ª–∏ –º—ã —Ö–æ—Ç–∏–º –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –º—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `message_handler`, –ø–æ–º–µ—Å—Ç–∏–≤ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä `@dp.message_handler` –Ω–∞–¥ —Ñ—É–Ω–∫—Ü–∏–µ–π. –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ —Ñ—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É.

–í –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–µ –º—ã –º–æ–∂–µ–º —É–∫–∞–∑–∞—Ç—å —É—Å–ª–æ–≤–∏—è, –ø—Ä–∏ –∫–æ—Ç–æ—Ä—ã—Ö –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è —Ñ—É–Ω–∫—Ü–∏—è. –ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –º—ã —Ö–æ—Ç–∏–º, —á—Ç–æ–±—ã —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–ª–∞—Å—å —Ç–æ–ª—å–∫–æ —Ç–æ–≥–¥–∞, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º `/start`, —Ç–æ –º—ã –Ω–∞–ø–∏—à–µ–º —Å–ª–µ–¥—É—é—â–µ–µ:

```
@dp.message_handler(commands=['start'])
```

–•–µ–Ω–¥–ª–µ—Ä—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –Ω–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é. –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å `async def`. –°–∏–Ω—Ç–∞–∫—Å–∏—Å `async def` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ.

#### /start

–î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω–µ–º —Å —Ö–µ–Ω–¥–ª–µ—Ä–∞ –∫–æ–º–∞–Ω–¥—ã `/start`.

```python
@dp.message_handler(commands=['start'], state='*')
async def cmd_start(message: types.Message):
    await message.answer(f"WORKMODE: {WORK_MODE}")
    # check if user is in database. if not, add him
    isOld = db.check_user(
        message.from_user.id, message.from_user.username, message.from_user.first_name)
    # if user already in database, we can address him differently
    if isOld == False:
        await message.answer(f"You are new here, {message.from_user.first_name}!")
        await message.answer(f"to buy air send /buy")
    else:
        await message.answer(f"Welcome once again, {message.from_user.first_name}!")
        await message.answer(f"to buy more air send /buy")
    await DataInput.firstState.set()
```

–í –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–µ —ç—Ç–æ–≥–æ —Ö–µ–Ω–¥–ª–µ—Ä–∞ –º—ã –≤–∏–¥–∏–º `state='*'`. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –¥–∞–Ω–Ω—ã–π —Ö–µ–Ω–¥–ª–µ—Ä –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–æ—Ç–∞. –ï—Å–ª–∏ –º—ã —Ö–æ—Ç–∏–º, —á—Ç–æ–±—ã —Ö–µ–Ω–¥–ª–µ—Ä –≤—ã–∑—ã–≤–∞–ª—Å—è —Ç–æ–ª—å–∫–æ —Ç–æ–≥–¥–∞, –∫–æ–≥–¥–∞ –±–æ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏, –º—ã –Ω–∞–ø–∏—à–µ–º `state=DataInput.firstState`. –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ —Ö–µ–Ω–¥–ª–µ—Ä –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω —Ç–æ–ª—å–∫–æ —Ç–æ–≥–¥–∞, –∫–æ–≥–¥–∞ –±–æ—Ç –±—É–¥–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `firstState`.

–ü–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏—Ç –∫–æ–º–∞–Ω–¥—É `/start`, –±–æ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, –∏—Å–ø–æ–ª—å–∑—É—è —Ñ—É–Ω–∫—Ü–∏—é `db.check_user`. –ï—Å–ª–∏ –Ω–µ—Ç, –æ–Ω –¥–æ–±–∞–≤–∏—Ç –µ–≥–æ. –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç–∞–∫–∂–µ –≤–µ—Ä–Ω–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ bool, –∏ –º—ã –º–æ–∂–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –¥–ª—è –¥—Ä—É–≥–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –±–æ—Ç —É—Å—Ç–∞–Ω–æ–≤–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ `firstState`.

#### /cancel

–î–∞–ª–µ–µ —Å–ª–µ–¥—É–µ—Ç —Ö–µ–Ω–¥–ª–µ—Ä –∫–æ–º–∞–Ω–¥—ã /cancel. –û–Ω –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ `firstState`.

```python
@dp.message_handler(commands=['cancel'], state="*")
async def cmd_cancel(message: types.Message):
    await message.answer("Canceled")
    await message.answer("/start to restart")
    await DataInput.firstState.set()
```

#### /buy

–ò, –∫–æ–Ω–µ—á–Ω–æ –∂–µ, —Ö–µ–Ω–¥–ª–µ—Ä –∫–æ–º–∞–Ω–¥—ã `/buy`. –í —ç—Ç–æ–º –ø—Ä–∏–º–µ—Ä–µ –º—ã –±—É–¥–µ–º –ø—Ä–æ–¥–∞–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ –≤–∏–¥—ã –≤–æ–∑–¥—É—Ö–∞. –î–ª—è –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –≤–æ–∑–¥—É—Ö–∞ –º—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å reply –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É.

```python
# /buy command handler
@dp.message_handler(commands=['buy'], state=DataInput.firstState)
async def cmd_buy(message: types.Message):
    # reply keyboard with air types
    keyboard = types.ReplyKeyboardMarkup(
        resize_keyboard=True, one_time_keyboard=True)
    keyboard.add(types.KeyboardButton('Just pure üå´'))
    keyboard.add(types.KeyboardButton('Spring forest üå≤'))
    keyboard.add(types.KeyboardButton('Sea breeze üåä'))
    keyboard.add(types.KeyboardButton('Fresh asphalt üõ£'))
    await message.answer(f"Choose your air: (or /cancel)", reply_markup=keyboard)
    await DataInput.secondState.set()
```

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–º–∞–Ω–¥—É `/buy`, –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–º—É –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ —Ç–∏–ø–æ–≤ –≤–æ–∑–¥—É—Ö–∞. –ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–µ—Ä–µ—Ç —Ç–∏–ø –≤–æ–∑–¥—É—Ö–∞, –±–æ—Ç —É—Å—Ç–∞–Ω–æ–≤–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ `secondState`.

–≠—Ç–æ—Ç —Ö–µ–Ω–¥–ª–µ—Ä –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–æ–≥–¥–∞, –∫–æ–≥–¥–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ `secondState`, –∏ –±—É–¥–µ—Ç –æ–∂–∏–¥–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ç–∏–ø–æ–º –≤–æ–∑–¥—É—Ö–∞.  –í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ –Ω–∞–º –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–∏–ø –≤–æ–∑–¥—É—Ö–∞, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–±—Ä–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –ø–æ—ç—Ç–æ–º—É –º—ã –ø–µ—Ä–µ–¥–∞–µ–º FSMContext –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ —Ñ—É–Ω–∫—Ü–∏–∏.

FSMContext –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ –ø–∞–º—è—Ç–∏ –±–æ—Ç–∞. –ú—ã –º–æ–∂–µ–º —Ö—Ä–∞–Ω–∏—Ç—å –≤ –Ω–µ–π –ª—é–±—ã–µ –¥–∞–Ω–Ω—ã–µ, –Ω–æ —ç—Ç–∞ –ø–∞–º—è—Ç—å –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π, –ø–æ—ç—Ç–æ–º—É –µ—Å–ª–∏ –±–æ—Ç –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω, –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã. –ù–æ –≤ –Ω–µ–π —Ö–æ—Ä–æ—à–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.

```python
# handle air type
@dp.message_handler(state=DataInput.secondState)
async def air_type(message: types.Message, state: FSMContext):
    if message.text == "Just pure üå´":
        await state.update_data(air_type="Just pure üå´")
    elif message.text == "Fresh asphalt üõ£":
        await state.update_data(air_type="Fresh asphalt üõ£")
    elif message.text == "Spring forest üå≤":
        await state.update_data(air_type="Spring forest üå≤")
    elif message.text == "Sea breeze üåä":
        await state.update_data(air_type="Sea breeze üåä")
    else:
        await message.answer("Wrong air type")
        await DataInput.secondState.set()
        return
    await DataInput.WalletState.set()
    await message.answer(f"Send your wallet address")
```

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ...

```python
await state.update_data(air_type="Just pure üå´")
```

...—á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–∏–ø –≤–æ–∑–¥—É—Ö–∞ –≤ FSMContext. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –º—ã —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ `WalletState` –∏ –ø—Ä–æ—Å–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–¥—Ä–µ—Å —Å–≤–æ–µ–≥–æ –∫–æ—à–µ–ª—å–∫–∞.

–≠—Ç–æ—Ç —Ö–µ–Ω–¥–ª–µ—Ä –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–æ–≥–¥–∞, –∫–æ–≥–¥–∞ `WalletState` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –±—É–¥–µ—Ç –æ–∂–∏–¥–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∞–¥—Ä–µ—Å–æ–º –∫–æ—à–µ–ª—å–∫–∞.

–°–ª–µ–¥—É—é—â–∏–π —Ö–µ–Ω–¥–ª–µ—Ä –∫–∞–∂–µ—Ç—Å—è –æ—á–µ–Ω—å —Å–ª–æ–∂–Ω—ã–º, –Ω–æ —ç—Ç–æ –Ω–µ —Ç–∞–∫. –°–Ω–∞—á–∞–ª–∞ –º—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º –∞–¥—Ä–µ—Å–æ–º –∫–æ—à–µ–ª—å–∫–∞, –∏—Å–ø–æ–ª—å–∑—É—è `len(message.text) == 48`, –ø–æ—Å–∫–æ–ª—å–∫—É –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ 48 —Å–∏–º–≤–æ–ª–æ–≤. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é `api.detect_address`, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∞–¥—Ä–µ—Å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º. –ö–∞–∫ –≤—ã –ø–æ–º–Ω–∏—Ç–µ –∏–∑ —á–∞—Å—Ç–∏, –ø–æ—Å–≤—è—â–µ–Ω–Ω–æ–π API, —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç–∞–∫–∂–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç "Correct" –∞–¥—Ä–µ—Å, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –º—ã –ø–æ–ª—É—á–∞–µ–º —Ç–∏–ø –≤–æ–∑–¥—É—Ö–∞ –∏–∑ FSMContext —Å –ø–æ–º–æ—â—å—é `await state.get_data()` –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `user_data`.

–¢–µ–ø–µ—Ä—å —É –Ω–∞—Å –µ—Å—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–ø–ª–∞—Ç—ã. –û—Å—Ç–∞–ª–æ—Å—å —Ç–æ–ª—å–∫–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –µ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é. –î–∞–≤–∞–π—Ç–µ –≤–æ—Å–ø–æ–ª—å–∑—É–µ–º—Å—è –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π.

–í —ç—Ç–æ–º –ø—Ä–∏–º–µ—Ä–µ –¥–ª—è –æ–ø–ª–∞—Ç—ã –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã —Ç—Ä–∏ –∫–Ω–æ–ø–∫–∏:

- –¥–ª—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ –ö–æ—à–µ–ª—å–∫–∞ TON
- –¥–ª—è Tonhub
- –¥–ª—è Tonkeeper

–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ –¥–ª—è –∫–æ—à–µ–ª—å–∫–æ–≤ –∑–∞–∫–ª—é—á–∞–µ—Ç—Å—è –≤ —Ç–æ–º, —á—Ç–æ –µ—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—â–µ –Ω–µ—Ç –∫–æ—à–µ–ª—å–∫–∞, —Ç–æ —Å–∞–π—Ç –ø—Ä–µ–¥–ª–æ–∂–∏—Ç –µ–º—É —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –µ–≥–æ.

–í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ, —á—Ç–æ –∑–∞—Ö–æ—Ç–∏—Ç–µ.

–ù–∞–º –Ω—É–∂–Ω–∞ –∫–Ω–æ–ø–∫–∞, –∫–æ—Ç–æ—Ä—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–º–µ—Ç –ø–æ—Å–ª–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, —á—Ç–æ–±—ã –º—ã –º–æ–≥–ª–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —É—Å–ø–µ—à–Ω–æ –ª–∏ –ø—Ä–æ—à–ª–∞ –æ–ø–ª–∞—Ç–∞.

```python
@dp.message_handler(state=DataInput.WalletState)
async def user_wallet(message: types.Message, state: FSMContext):
    if len(message.text) == 48:
        res = api.detect_address(message.text)
        if res == False:
            await message.answer("Wrong wallet address")
            await DataInput.WalletState.set()
            return
        else:
            user_data = await state.get_data()
            air_type = user_data['air_type']
            # inline button "check transaction"
            keyboard2 = types.InlineKeyboardMarkup(row_width=1)
            keyboard2.add(types.InlineKeyboardButton(
                text="Check transaction", callback_data="check"))
            keyboard1 = types.InlineKeyboardMarkup(row_width=1)
            keyboard1.add(types.InlineKeyboardButton(
                text="Ton Wallet", url=f"ton://transfer/{WALLET}?amount=1000000000&text={air_type}"))
            keyboard1.add(types.InlineKeyboardButton(
                text="Tonkeeper", url=f"https://app.tonkeeper.com/transfer/{WALLET}?amount=1000000000&text={air_type}"))
            keyboard1.add(types.InlineKeyboardButton(
                text="Tonhub", url=f"https://tonhub.com/transfer/{WALLET}?amount=1000000000&text={air_type}"))
            await message.answer(f"You choose {air_type}")
            await message.answer(f"Send <code>1</code> toncoin to address \n<code>{WALLET}</code> \nwith comment \n<code>{air_type}</code> \nfrom your wallet ({message.text})", reply_markup=keyboard1)
            await message.answer(f"Click the button after payment", reply_markup=keyboard2)
            await DataInput.PayState.set()
            await state.update_data(wallet=res)
            await state.update_data(value_nano="1000000000")
    else:
        await message.answer("Wrong wallet address")
        await DataInput.WalletState.set()
```

#### /me

–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ö–µ–Ω–¥–ª–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞–º –Ω—É–∂–µ–Ω, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –∫–æ–º–∞–Ω–¥—ã `/me`. –û–Ω –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–ª–∞—Ç–µ–∂–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

```python
# /me command handler
@dp.message_handler(commands=['me'], state="*")
async def cmd_me(message: types.Message):
    await message.answer(f"Your transactions")
    # db.get_user_payments returns list of transactions for user
    transactions = db.get_user_payments(message.from_user.id)
    if transactions == False:
        await message.answer(f"You have no transactions")
    else:
        for transaction in transactions:
            # we need to remember that blockchain stores value in nanotons. 1 toncoin = 1000000000 in blockchain
            await message.answer(f"{int(transaction['value'])/1000000000} - {transaction['comment']}")
```

### –•–µ–Ω–¥–ª–µ—Ä—ã Callback

–ú—ã –º–æ–∂–µ–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å callback-–¥–∞–Ω–Ω—ã–µ –≤ –∫–Ω–æ–ø–∫–∞—Ö, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –±–æ—Ç—É –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –Ω–∞ –∫–Ω–æ–ø–∫—É. –í –∫–Ω–æ–ø–∫–µ, –∫–æ—Ç–æ—Ä—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–º–µ—Ç –ø–æ—Å–ª–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –º—ã —É—Å—Ç–∞–Ω–æ–≤–∏–º callback data –Ω–∞ "check". –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –Ω–∞–º –Ω—É–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —ç—Ç–æ—Ç callback.

Callback-—Ö–µ–Ω–¥–ª–µ—Ä—ã –æ—á–µ–Ω—å –ø–æ—Ö–æ–∂–∏ –Ω–∞ —Ö–µ–Ω–¥–ª–µ—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π, –Ω–æ –≤–º–µ—Å—Ç–æ `message` –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ —É –Ω–∏—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `types.CallbackQuery`. –î–µ–∫–æ—Ä–∞—Ç–æ—Ä —Ñ—É–Ω–∫—Ü–∏–∏ —Ç–∞–∫–∂–µ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è.

```python
@dp.callback_query_handler(lambda call: call.data == "check", state=DataInput.PayState)
async def check_transaction(call: types.CallbackQuery, state: FSMContext):
    # send notification
    user_data = await state.get_data()
    source = user_data['wallet']
    value = user_data['value_nano']
    comment = user_data['air_type']
    result = api.find_transaction(source, value, comment)
    if result == False:
        await call.answer("Wait a bit, try again in 10 seconds. You can also check the status of the transaction through the explorer (tonscan.org/)", show_alert=True)
    else:
        db.v_wallet(call.from_user.id, source)
        await call.message.edit_text("Transaction is confirmed \n/start to restart")
        await state.finish()
        await DataInput.firstState.set()
```

–í —ç—Ç–æ–º —Ö–µ–Ω–¥–ª–µ—Ä–µ –º—ã –ø–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ FSMContext –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é `api.find_transaction`, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±—ã–ª–∞ –ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É—Å–ø–µ—à–Ω–æ–π. –ï—Å–ª–∏ –¥–∞, —Ç–æ –º—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –Ω–∞–π—Ç–∏ —Å–≤–æ–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã `/me`.

### –ü–æ—Å–ª–µ–¥–Ω—è—è —á–∞—Å—Ç—å main.py

–í –∫–æ–Ω—Ü–µ –Ω–µ –∑–∞–±—É–¥—å—Ç–µ:

```python
if __name__ == '__main__':
    executor.start_polling(dp, skip_updates=True)
```

–≠—Ç–∞ —á–∞—Å—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞.
–í `skip_updates=True` –º—ã —É–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –Ω–µ —Ö–æ—Ç–∏–º –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è. –ù–æ –µ—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –≤—ã –º–æ–∂–µ—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ `False`.

:::info

–í–µ—Å—å –∫–æ–¥ `main.py` –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ [–∑–¥–µ—Å—å](https://github.com/LevZed/ton-payments-in-telegram-bot/blob/main/bot/main.py).

:::

## –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω

–ú—ã –Ω–∞–∫–æ–Ω–µ—Ü-—Ç–æ —Å–¥–µ–ª–∞–ª–∏ —ç—Ç–æ! –¢–µ–ø–µ—Ä—å —É –≤–∞—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–∞–±–æ—Ç–∞—é—â–∏–π –±–æ—Ç. –í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ!

–®–∞–≥–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞:

1. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–∞–π–ª `config.json`.
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ `main.py`.

–í—Å–µ —Ñ–∞–π–ª—ã –¥–æ–ª–∂–Ω—ã –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ –æ–¥–Ω–æ–π –ø–∞–ø–∫–µ. –ß—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞, –≤–∞–º –Ω—É–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ñ–∞–π–ª `main.py`. –í—ã –º–æ–∂–µ—Ç–µ —Å–¥–µ–ª–∞—Ç—å —ç—Ç–æ –≤ IDE –∏–ª–∏ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:

```
python main.py
```

–ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–ª–∏ –æ—à–∏–±–∫–∏, –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Ö –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ. –í–æ–∑–º–æ–∂–Ω–æ, –≤—ã —á—Ç–æ-—Ç–æ —É–ø—É—Å—Ç–∏–ª–∏ –≤ –∫–æ–¥–µ.

–ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ –±–æ—Ç–∞ [@AirDealerBot](https://t.me/AirDealerBot)

![bot](/img/tutorials/apiatb-bot.png)

## –°—Å—ã–ª–∫–∏

- –°–¥–µ–ª–∞–Ω–æ –¥–ª—è TON –∫–∞–∫ —á–∞—Å—Ç—å [ton-footsteps/8](https://github.com/ton-society/ton-footsteps/issues/8)
- By Lev ([Telegram @Revuza](https://t.me/revuza), [LevZed –Ω–∞ GitHub](https://github.com/LevZed))
