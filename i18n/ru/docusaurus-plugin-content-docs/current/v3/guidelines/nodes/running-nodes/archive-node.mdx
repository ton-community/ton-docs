# Архивный узел

:::warning
Эта страница переведена сообществом на русский язык, но нуждается в улучшениях. Если вы хотите принять участие в переводе свяжитесь с [@alexgton](https://t.me/alexgton).
:::

:::info
Прочитайте о [Полном узле](/v3/guidelines/nodes/running-nodes/full-node) перед этой статьей
:::

## Обзор

Архивный узел - это тип полного узла, который хранит расширенные исторические данные блокчейна. Если вы создаете обозреватель блокчейна или аналогичное приложение, которому требуется доступ к историческим данным, рекомендуется использовать архивный узел в качестве индексатора.

## Требования к ОС

Мы настоятельно рекомендуем установить mytonctrl с использованием поддерживаемых операционных систем:

- Ubuntu 20.04
- Ubuntu 22.04
- Debian 11

## Требования к аппаратному обеспечению

- 16 x ядерный процессор
- 128ГБ ОЗУ с исправлением ошибок (ECC)
- Твердотельный накопитель объемом 9 ТБ *или* Оборудованное хранилище с более 64 000 операций ввода/вывода в секунду (IOPS)
- Возможность подключения к сети 1 Гбит/с
- 16 ТБ/месяц трафика при пиковой нагрузке
- публичный IP-адрес (фиксированный IP-адрес)

:::info Сжатие данных
Для несжатых данных требуется 9 ТБ. 6 ТБ - это при использовании тома ZFS с включенным сжатием.
Объем данных увеличивается примерно на 0,5 ТБ и 0,25 ТБ каждый месяц, с последним обновлением в ноябре 2024 года.
:::

## Установка

### Установите ZFS и подготовьте том

Дампы поставляются в виде снимков ZFS, сжатых с помощью plzip, вам необходимо установить ZFS на вашем хосте и восстановить дамп, см. в [Документацию Oracle](https://docs.oracle.com/cd/E23824_01/html/821-1448/gavvx.html#scrolltoc).

Обычно рекомендуется создать отдельный пул ZFS для вашего узла на выделенном SSD-диске, это позволит вам легко управлять дисковым пространством и создавать резервные копии вашего узла.

1. Установите [zfs](https://ubuntu.com/tutorials/setup-zfs-storage-pool#1-overview)

```shell
sudo apt install zfsutils-linux
```

2. [Создайте пул](https://ubuntu.com/tutorials/setup-zfs-storage-pool#3-creating-a-zfs-pool) на вашем выделенном диске объемом 4 ТБ `<disk>` и назовите его `data`

```shell
sudo zpool create data <disk>
```

3. Перед восстановлением настоятельно рекомендуем включить сжатие на родительском файловой системе ZFS, что позволит вам освободить [много места](https://www.servethehome.com/the-case-for-using-zfs-compression/). Чтобы включить сжатие для тома `data`, войдите под учетной записью root и выполните следующую команду:

```shell
sudo zfs set compression=lz4 data
```

### Установите MyTonCtrl

Пожалуйста, используйте [Запуск Полного узла](/v3/guidelines/nodes/running-nodes/full-node) чтобы **установить** и **запустить** mytonctrl.

### Запустите архивный узел

#### Подготовьте узел

1. Перед выполнением восстановления вы должны остановить validator под учетной записью root:

```shell
sudo -s
systemctl stop validator.service
```

2. Сделайте резервную копию файлов конфигурации `ton-work` (нам потребуются файлы `/var/ton-work/db/config.json`, `/var/ton-work/keys` и `/var/ton-work/db/keyring`).

```shell
mv /var/ton-work /var/ton-work.bak
```

#### Скачайте дамп

1. Запросите учетные данные `user` и `password`для получения доступа к скачиванию дампов в чате [@TONBaseChatEn](https://t.me/TONBaseChatEn) в Telegram.
2. Вот пример команды для скачивания и восстановления дампа **mainnet** с сервера ton.org:

```shell
wget --user <usr> --password <pwd> -c https://archival-dump.ton.org/dumps/latest.zfs.lz | pv | plzip -d -n <cores> | zfs recv data/ton-work
```

Чтобы установить дамп **testnet**, используйте следующую команду:

```shell
wget --user <usr> --password <pwd> -c https://archival-dump.ton.org/dumps/latest_testnet.zfs.lz | pv | plzip -d -n <cores> | zfs recv data/ton-work
```

Размер дампа составляет примерно **4 Тб**, поэтому скачивание и восстановление могут занять несколько дней (до 4 дней). Размер дампа может увеличиваться с ростом сети.

Подготовьте и выполните команду:

1. При необходимости установите инструменты (`pv`, `plzip`)
2. Замените `<usr>` и `<pwd>` вашими учетными данными
3. Сообщите `plzip` использовать столько ядер, сколько позволяет ваша машина для ускорения извлечения (`-n`)

#### Установите дамп

1. Смонтируйте zfs:

```shell
zfs set mountpoint=/var/ton-work data/ton-work && zfs mount data/ton-work
```

2. Восстановите `db/config.json`, `keys` и `db/keyring` из резервной копии в `/var/ton-work`.

```shell
cp /var/ton-work.bak/db/config.json /var/ton-work/db/config.json
cp -r /var/ton-work.bak/keys /var/ton-work/keys
cp -r /var/ton-work.bak/db/keyring /var/ton-work/db/keyring
```

3. Убедитесь, что разрешения для каталогов `/var/ton-work` и `/var/ton-work/keys` предоставлены правильно:

- Владельцем каталога `/var/ton-work/db` должен быть пользователь `validator`:

```shell
chown -R validator:validator /var/ton-work/db
```

- Владельцем каталога `/var/ton-work/keys` должен быть пользователь `ubuntu`:

```shell
chown -R ubuntu:ubuntu /var/ton-work/keys
```

#### Обновите конфигурацию

Обновите конфигурацию узла для архивного узла.

1. Откройте файл конфигурации узла `/etc/systemd/system/validator.service`.

```shell
nano /etc/systemd/system/validator.service
```

2. Добавьте настройки хранилища для узла в строке `ExecStart`:

```shell
--state-ttl 315360000 --archive-ttl 315360000 --block-ttl 315360000
```

:::info
Пожалуйста, будьте терпеливы после запуска узла и следите за логами.
Дампы не содержат кэшей DHT, поэтому вашему узлу потребуется время для поиска других узлов и синхронизации с ними.
В зависимости от возраста снимка и скорости вашего интернет-соединения, процесс восстановления может занять у вас **от нескольких часов до нескольких дней**.
**На минимальной конфигурации этот процесс может занять до 5 дней.**
Это нормально.
:::

:::caution
Если процесс синхронизации узла уже занял 5 дней, но узел все еще не синхронизирован, вам следует проверить [раздел устранения неполадок](/v3/guidelines/nodes/nodes-troubleshooting#archive-node-is-out-of-sync-even-after-5-days-of-the-syncing-process).
:::

#### Запустите узел

1. Запустите validator, выполнив команду:

```shell
systemctl start validator.service
```

2. Откройте `mytonctrl` из *local user* и проверьте состояние узла с помощью команды `status`.

## Обслуживание узла

База данных узла требует периодической очистки (мы рекомендуем проводить ее раз в неделю), для этого, пожалуйста, выполните следующие шаги под учетной записью root:

1. Остановите процесс validator (Никогда не пропускайте этот момент!)

```shell
sudo -s
systemctl stop validator.service
```

2. Удалите старые логи

```shell
find /var/ton-work -name 'LOG.old*' -exec rm {} +
```

4. Удалите временные файлы

```shell
rm -r /var/ton-work/db/files/packages/temp.archive.*
```

5. Запустите процесс validator

```shell
systemctl start validator.service
```

## Устранение неполадок и резервное копирование

Если по какой-то причине что-то не работает или ломается, вы всегда можете [откатиться](https://docs.oracle.com/cd/E23824_01/html/821-1448/gbciq.html#gbcxk) к снимку @archstate в вашей файловой системе ZFS, это исходное состояние, полученное из дампа.

1. Остановите процесс валидатора (\*\*Никогда не пропускайте это! \*\*).

```shell
sudo -s
systemctl stop validator.service
```

2. Проверьте имя моментального снимка

```shell
zfs list -t snapshot
```

3. Откатить к состоянию моментального снимка

```shell
zfs rollback data/ton-work@dumpstate
```

Если ваш узел работает нормально, вы можете удалить моментальный снимок, чтобы сэкономить место на диске, но мы рекомендуем регулярно делать снимки вашей файловой системы для целей отката, поскольку известно, что узел валидатора может повреждать данные и config.json. [zfsnap](https://www.zfsnap.org/docs.html) - это отличный инструмент для автоматизации циклической обработки снимков.

:::tip Нужна помощь?
У вас есть вопросы или вам нужна помощь? Пожалуйста, задавайте вопросы в [TON Dev Chat (РУ)](https://t.me/tondev), чтобы получить помощь сообщества. Разработчики MyTonCtrl также присутствуют там.
:::

## Советы и рекомендации

### Заставьте архивный узел не хранить блоки

Чтобы заставить узел не хранить архивные блоки, используйте значение 86400. Подробнее смотрите в разделе [set_node_argument](/v3/documentation/infra/nodes/mytonctrl/mytonctrl-overview#set_node_argument).

```bash
installer set_node_argument --archive-ttl 86400
```

## Поддержка

Обратитесь в службу технической поддержки по ссылке [@mytonctrl_help](https://t.me/mytonctrl_help).

## См. также

- [Типы узлов TON](/v3/documentation/infra/nodes/node-types)
- [Запуск полного узла](/v3/guidelines/nodes/running-nodes/full-node)
