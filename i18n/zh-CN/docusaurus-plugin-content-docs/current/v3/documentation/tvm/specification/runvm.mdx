import Feedback from '@site/src/components/Feedback';

# RUNVM 规格

Currently, TVM does not provide a mechanism for executing external untrusted code within a secure sandbox environment. In other words, any external code invoked has unrestricted access and can permanently modify the contract's code and data or trigger actions such as transferring all funds.

The `RUNVM` instruction creates an isolated VM instance, allowing code execution while safely retrieving data such as stack state, registers, and gas consumption. This ensures the caller's state remains unaffected. This allows arbitrary code to run safely, which is helpful for [v4-style plugins](/v3/documentation/smart-contracts/contracts-specs/wallet-contracts#wallet-v4), Tact's `init`-style subcontract calculations, and similar use cases.

| Fift syntax   | Stack                                                                                                    | xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx<br/>说明                                                                                                                                                                                                                                                                                                                                                                                                          |
| :------------ | :------------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `flags RUNVM` | _`x_1 ... x_n n code [r] [c4] [c7] [g_l] [g_m] - x'_1 ... x'_m exitcode [data'] [c4'] [c5] [g_c]`_       | Executes a child VM with the given `code` and stack values `x_1 ... x_n`. Returns the modified stack `x'_1 ... x'_m` along with an exit code. <br/> Flags determine other arguments and return values. See details below.                                                                                                                                                                                                                                  |
| `RUNVMX`      | _`x_1 ... x_n n code [r] [c4] [c7] [g_l] [g_m] flags - x'_1 ... x'_m exitcode [data'] [c4'] [c5] [g_c]`_ | It is the same as `RUNVM` but retrieves flags from the stack.                                                                                                                                                                                                                                                                                                                                                                                              |

标志类似于 fift 中的 `runvmx`：

- `+1`：设置 c3 为代码
- `+2`：运行代码前推送一个隐式 0 Note, it only works with +1 flag set
- \+4"： 从堆栈中取出 `c4`（持久数据），返回其最终值
- `+8`：从堆栈中取gas限制`g_l`，返回消耗的gas `g_c`
- `+16`：从堆栈中取出 `c7` （智能合约上下文）
- `+32`：返回`c5`的最终值（操作）
- `+64`：从堆栈中弹出硬gas限制（由ACCEPT启用）`g_m`
- `+128`："孤立的 gas 消耗"。子虚拟机将有一组单独的访问 cell 和一个单独的 chksgn 计数器。
- `+256`：弹出整数 `r`，从顶部返回整数 `r` 值：
  - 如果 RUNVM 调用成功且 r 已设置，则返回 r 个元素。如果 r 未设置，则返回所有元素； If `r` is not set, it returns all available elements.
  - 如果 RUNVM 成功，但堆栈中没有足够的元素（堆栈深度小于 r），则在子虚拟机中视为异常，exit_code=-3，exit_arg=0（因此 0 将作为唯一的堆栈元素返回）； The `exit_code` is set to `-3`, and `exit_arg` is set to `0`, so `0` is returned as the only stack element.
  - 如果 RUNVM 异常失败 - 只返回一个元素 - exit arg（不要误认成 exit_code ）；
  - 如果是 OOG，exit_code = -14，exit_arg 为 gas 量。

gas成本：

- 66 gas
- 每向子虚拟机提供一个堆栈元素，就产生 1 个 gas （前 32 个免费）
- 子虚拟机每返回一个堆栈元素，就产生 1 个 gas （前 32 个免费）

## 另请参见

- [TVM 说明](/v3/documentation/tvm/instructions)

<Feedback />
