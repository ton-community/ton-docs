import Feedback from '@site/src/components/Feedback';

import Button from '@site/src/components/button'

# TVM 概览

The TON Virtual Machine (TVM) executes all TON smart contracts. TVM operates on the **stack principle**, which ensures efficiency and ease of implementation.

本文档提供 TVM 如何执行事务的鸟瞰图。

:::tip

- TVM 源 - [**TVM C++ 实现**](https://github.com/ton-blockchain/ton/tree/master/crypto/vm)
- [TVM Retracer](https://retracer.ton.org/)
  :::

## TON 课程：TVM

:::tip
Before starting the course, ensure you have a solid understanding of blockchain basics. If you need to fill knowledge gaps, consider taking the [Blockchain basics with TON](https://stepik.org/course/201294/promo) course ([RU version](https://stepik.org/course/202221/), [CHN version](https://stepik.org/course/200976/)).
:::

[TON Blockchain 课程](https://stepik.org/course/176754/)是TON Blockchain 开发的综合指南。 模块 2 完全涵盖 **TVM**、事务、可扩展性和业务案例。

<Button href="https://stepik.org/course/176754/promo"
        colorType={'primary'} sizeType={'sm'}>

检查 TON 区块链课程

</Button>

<Button href="https://stepik.org/course/201638/promo"
        colorType={'secondary'} sizeType={'sm'}>

CHN

</Button>

<Button href="https://stepik.org/course/201855/promo"
        colorType={'secondary'} sizeType={'sm'}>

RU

</Button>

## Transactions and phases

当某个 TON 链上的账户发生某些事件时，就会引起**交易**。最常见的事件是 "某些信息的到达"，但一般来说也可能有 "滴答"、"合并"、"拆分 "和其他事件。 The most common event is receiving a message, but other events like `tick-tock`, `merge`, and `split` can also initiate transactions.

每个交易最多由 5 个阶段组成：

1. **Storage phase** - in this phase, storage fees accumulated by the contract due to the occupation of some space in the chain state are calculated. Read more in [Storage Fees](/develop/smart-contracts/fees#storage-fee).
2. **Credit phase** - 在这一阶段，将计算与（可能的）接收信息值有关的合约余额和收取的存储费。
3. **Compute phase**: executes the contract code on TVM. The result includes `exit_code`, `actions`, `gas_details`, `new_storage`, and other data.
4. **Action phase**: processes actions from the compute phase if it succeeds. Actions may include sending messages, updating contract code, or modifying libraries. If an action fails, for example, due to lack of funds, the transaction may revert or skip the action, depending on its mode (`send-or-revert` or `try-send-if-no-ignore`).
5. **Bounce phase** - 如果计算阶段失败（返回 `exit_code >=2`），在此阶段，将为由传入报文启动的事务生成_反弹报文_。

## Compute phase

The compute phase involves executing the contract code on TVM.

:::tip

- TVM 4.3.5 - [**TON 区块链论文**](https://docs.ton.org/assets/files/tblkch-6aaf006b94ee2843a982ebf21d7c1247.pdf)
  :::

### 计算阶段跳过

The compute phase may be skipped under certain conditions, such as when the account is missing, uninitialized, or frozen, or when the incoming message lacks code or data fields. These scenarios are represented by specific constructors:

- `cskip_no_state$00` - 帐户（不存在、未初始化或冻结）和报文中的[无状态](https://testnet.tonviewer.com/transaction/7e78394d082882375a5d21affa6397dec60fc5a3ecbea87f401b0e460fb5c80c)（即智能合约代码和数据）。
- `cskip_bad_state$01` - 信息中传递的无效状态（即状态的哈希值与预期值不同）到冻结或未初始化的帐户。
- `cskip_no_gas$10` - [没有资金](https://testnet.tonviewer.com/transaction/a1612cde7fd66139a7d04b30f38db192bdb743a8b12054feba3c16061a4cb9a6) 购买 gas 。(大约 < 0.00004 TON by [08.2024](https://testnet.tonviewer.com/transaction/9789306d7b29318c90477aa3df6599ee4a897031162ad41a24decb87db65402b))

### TVM 状态

在任何给定时刻，TVM 的状态完全由 6 种属性决定：

- **Stack**: a last-in-first-out data structure.
- Control registers --（见下文）简单地说，这意味着在执行过程中最多可直接设置和读取 16 个变量
- Current continuation - 描述当前执行的指令序列的对象
- **Current codepage**: specifies the TVM version in use.
- Gas limits - 一组 4 个整数值；当前 gas 限值 g<sub>l</sub>、最大 gas 限值 g<sub>m</sub>、剩余 gas 限值 g<sub>r</sub>和 gas credit g<sub>c</sub>
- Library context - 可以由 TVM 调用的库的哈希映射

### TVM 的初始化

TVM operates as a stack machine, supporting seven variable types:

- **Non-cell types**:
  - Integer(整数) - 有符号的 257 位整数
  - Tuple(元组) - 由最多 255 个元素组成的有序集合，具有任意值类型，可能是不同的。
  - Null(空)
- **Cell types**:
  - Cell: basic data structure for storing information.
  - Slice: allows reading data from a cell.
  - Builder(构建器) - 一种特殊的对象，允许您创建新的cell
  - Continuation - 一种特殊对象，可将Cell用作 TVM 指令源

### 控制寄存器

- `c0` — 包含下一个 continuation 或返回 continuation（类似于常规设计中的子例程返回地址）。此值必须是一个 Continuation。
- `c1`: stores the alternative continuation.
- `c2`: contains the exception handler. Continuation.
- `c3` — 支持寄存器，包含当前字典，本质上是一个包含程序中使用的所有函数的代码的哈希映射。此值必须是一个 Continuation。 Continuation.
- `c4`: stores the persistent data (contract's `data` section). Cell.
- `c5`: contains output actions. Cell.
- `c7`: stores temporary data. Tuple.

### TVM 的初始化

TVM initializes during the compute phase and executes commands/opcodes from the **current continuation** until no more commands remain. Detailed description of the initialization process can be found here: [TVM Initialization](/learn/tvm-instructions/tvm-initialization.md)

## [TVM 指令](/learn/tvm-instructions/instructions)

The list of TVM instructions can be found here: [TVM instructions](/learn/tvm-instructions/instructions).

### TVM 执行结果

除了退出代码和消耗的 gas 数据外，TVM 还间接输出以下数据：

- c4 寄存器 - 将作为智能合约的新 `data` 存储的cell（如果执行不会在此阶段或以后的阶段回滚）
- `c5` — 包含输出操作。该值是一个 cell 。

Other register values are discarded. Note:

- The maximum cell depth during execution is `<1024`, but `c4` and `c5` must not exceed a depth of `512`.
- A contract can't create more than 255 output actions.

:::tip
To send more than 255 messages, a contract can send a message to itself with a request to process the remaining messages. See an example in the [highload wallet contract](https://github.com/ton-blockchain/highload-wallet-contract-v3/blob/main/contracts/highload-wallet-v3.func#L50).
:::

## 参阅

- [TVM Instructions](/learn/tvm-instructions/instructions)
- [TON TVM](https://ton.org/tvm.pdf) TVM 概念（可能包含过时的信息）

<Feedback />
