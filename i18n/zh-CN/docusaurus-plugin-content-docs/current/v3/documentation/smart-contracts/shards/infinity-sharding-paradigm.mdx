import Feedback from '@site/src/components/Feedback';

# 无限分片范式

## 理解TON区块链中的拆分合并

The TON (The Open Network) blockchain introduces innovative mechanisms for scalability and efficiency. One of the key features is **split-merge**, a fundamental component of its architecture. This article outlines the core principles of split-merge within the Infinite Sharding Paradigm (ISP) framework.

#### 无限分片范式（ISP）及其应用

At the heart of TON's design is the ISP, which treats each account as its own **AccountChain**—a unique chain of transactions associated with a single account. These AccountChains are grouped into ShardChain blocks to improve processing efficiency. The state of a ShardChain is derived from the combined states of all the AccountChains it contains. As a result, a ShardChain block can be viewed as a collection of virtual blocks corresponding to individual accounts.

- **ShardState**：近似表示为 Hashmap(n, AccountState)，其中n是account_id的位长度。
- **ShardBlock**：近似表示为 Hashmap(n, AccountBlock)。

每个分片链，或更准确地说，每个分片链区块，由`workchain_id`和账户id的二进制前缀`s`的组合来标识。

## Algorithm for deciding whether to split or merge

The decision to split or merge shards proceeds as follows:

1. Each block is evaluated using key metrics, such as block size, gas consumption, and logical time (LT) delta.
2. These metrics are used to determine whether the block is **overloaded** or **underloaded**.
3. Each shard maintains a history of overload and underload events. Based on recent trends, it sets `want_split` or `want_merge` flags.
4. Validators make split or merge decisions using these flags by configuration parameters.

### 1. 对当前区块状态评估

Each block includes three core parameters that are used to assess load:

1. _Block size estimation_ - 不是实际的块大小，而是在整理过程中计算出的估计值。
2. _Gas consumption_ - 所有交易中消耗的 gas 总量（不包括 ticktock 和造币/回收特殊交易）。
3. _Lt delta_ -- 区块起始和结束时长之差。

### 4. 决定区块的拆分还是合并

Limits for these metrics are defined in [configuration parameters 22 and 23](/v3/documentation/network/configs/blockchain-configs#param-22-and-23).
Each parameter has three thresholds: **underload**, **soft**, and **hard**:

#### Threshold table

| **Parameter**     | **Underload / Soft / Hard (BaseChain)**           | **Underload / Soft / Hard (MasterChain)**  |
| ----------------- | ------------------------------------------------- | ------------------------------------------ |
| Block size        | 128 / 256 / 512 KiB                               | N/A                                        |
| Gas consumption   | 2M / 10M / 20M                                    | 200K / 1M / 2.5M                           |
| LT delta          | _Lt delta_：`1000/5000/10000`.                     | Same as BaseChain                          |

此外，还有一个中等限制，等于 `(soft + hard) / 2`。

Each parameter is classified as follows:

- `0` - 未达到欠载限制。
- `1` - 超过欠载限制。
- `2` - 超过软限制。
- `3` - 超过介质限制。
- `4` - 超过硬限制。

区块分类最终的标准以最大值为主，在 (“size”、“gas”、“lt delta” ) 中取最大值
。 例如，如果尺寸分类为2，气体分类为3， lt delta的分类是。据此可以判断出最后的区块分类是3。

Example: size = 2, gas = 3, lt = 1 → block classification = 3.

Based on classification:

- 0 (Underload): merge candidate.
- 2 (Soft): internal messages are no longer processed; candidate for split.
- 3 (Medium): external messages are skipped.

### 3. 过载或欠载的判定

Additional heuristics are applied beyond classification based on the message queue status:

- A block is **overloaded** if:
  - 如果区块类别大于等于“2” (soft) 并且消息队列大小没有超过“SPLIT_MAX_QUEUE_SIZE = 100000”，则该块过载。
  - 如果达到了调度队列中已处理消息总数的限制，并且消息队列大小没有超过`SPLIT_MAX_QUEUE_SIZE = 100000`，则该区块判定为过载。
  - 如果消息队列尺寸大于等于`FORCE_SPLIT_QUEUE_SIZE = 4096`且没有超过`SPLIT_MAX_QUEUE_SIZE = 100000`，则该区块将被当作超载。
- A block is **underloaded** if:
  - 如果区块类别为“0” (欠载) 且消息队列大小没有超过“MERGE_MAX_QUEUE_SIZE = 2047”，则该块欠载。

### 5. 区块分割合并的最后决定

每个区块都保存着过载和欠载的历史记录——这是一个64位的掩码，记录了最近64个区块的过载/欠载状态 ，它被用来决定是否要进行分割或合并。 This mask is used to determine whether a shard should split or merge.

The underload and overload histories are evaluated using a weighted formula:

`one_bits(mask & 0xffff) * 3 + one_bits(mask & 0xffff0000) * 2 + one_bits(mask & 0xffff00000000) - (3 + 2 + 1) * 16 * 2 / 3`

Here, `one_bits` counts the number of `1`-bits in the mask. Lower-order bits correspond to the most recent blocks.

当欠载或过载的历史记录具有非负权重时，会设置 `want_merge` 或 `want_split` 标志。

### 5. Final decision

验证器使用这些标志合并或拆分分片。

验证者 (Validators ) 使用 `want_split`和 `want_merge`标志以及`工作链配置参数`[workchain configuration parameters](/v3/documentation/network/configs/blockchain-configs#param-12).来决定是否要分割或合并分片(shards)。

- 当块的分类为 2  轻微 (soft) 限制已经达到时，整理器停止处理内部消息。该块倾向于分裂。
- 每个分片都会保存欠载和过载历史。如果最近有足够多的区块被欠载或超载，就会设置 `want_merge` 或 `want_split` 标志。
- 深度为 `min_split` 的分片不能合并，深度为 `max_split` 的分片不能分割。
- 如果区块有`want_split`标志，分片将会分割。
- 如果区块及其兄弟区块都设置了 `want_merge` 标志，则这些分片将会合并。

分片将在做出决定后的 `split_merge_delay = 100` 秒内进行分割和合并。

## 消息和即时超立方路由（即时超立方路由）

In the infinite sharding paradigm, each account or smart contract is treated as if it were a part of its own ShardChain.
Interactions between accounts occur exclusively through message passing, following the **actor model**, where accounts act as actors.
An efficient messaging system between ShardChains is essential for the operation of the TON blockchain. A key feature supporting this is **Instant Hypercube Routing**, which enables near-instantaneous message delivery and processing across ShardChains. Messages created in one ShardChain block are processed in the next block of the target ShardChain — regardless of how many messages are in the system.

### Current Status of IHR

:::info Important Clarification

- **IHR is not implemented** and is not yet fully specified
- **IHR is only relevant** when there are more than 16 shards and not all shards are neighbors to each other
- **Current network settings forbid splitting deeper than 16 shards**, so IHR is not relevant in any practical sense today

Currently, TON uses standard **Hypercube Routing (HR)** for message delivery between shards, which routes messages through intermediate shards when necessary. IHR would provide a more direct routing mechanism, but only becomes necessary in much larger shard configurations than are currently possible.
:::

### Message Routing Mechanisms

TON blockchain supports two conceptual message routing mechanisms:

1. **Hypercube Routing (HR)** - Currently implemented mechanism that routes messages between shards through intermediate hops when necessary
2. **Instant Hypercube Routing (IHR)** - Alternative mechanism (not implemented) that would allow direct message delivery without intermediate hops

The choice between these mechanisms would depend on the network topology and shard configuration, but given current limitations on shard depth, only HR is relevant.

## 分片示例

![](/img/docs/blockchain-fundamentals/shardchains.jpg)

在提供的图形方案中：

- The shards of a WorkChain are shown over time and separated by dashed lines.
- Blocks 222, 223, and 224 correspond to MasterChain block `seqno = 102`. 区块 222、223 和 224 与 seqno=102 的主链区块有关。在这里，222 位于一个分片中，而 223 和 224 位于另一个分片中。
- 如果发生拆分或合并事件，受影响的分片会暂停，直到下一个主链块。

总之，TON区块链中的拆分合并是一个复杂但高效的机制，增强了区块链网络的可扩展性和交互性。它体现了TON解决常见区块链挑战的方法，强调效率和全局一致性。 It exemplifies TON's approach to solving core blockchain challenges by prioritizing efficiency and global consistency.

## 分片细节

#### 分片链的拆分和非拆分部分

一个分片链块和状态分为两部分：

1. **拆分部分**：符合ISP形式，包含特定于账户的数据。
2. **非拆分部分**：涉及区块与其他区块和外部世界的交互相关的数据。

#### 与其他块的交互

The non-split parts are vital in maintaining global consistency across the network. They address both internal and external local consistency conditions and are responsible for:

- Forwarding messages between ShardChains
- Facilitating cross-shard transactions
- 交付保证和验证，关于区块的初始状态与其前一个区块的一致性。

#### 入站和出站消息

分片链区块的非拆分部分的关键组成部分包括：

- **InMsgDescr**: describes all messages imported into the block. These messages are either:
  - processed by a block or transit transaction, i.e., temporarily forwarded as per `Hypercube Routing`.
- **OutMsgDescr**：区块输出或生成的所有消息的描述（即由区块中包含的交易生成的消息，或目的地不属于当前分片链的中转消息，由 `InMsgDescr` 转发）。 These may be:
  - newly generated messages from a transaction in the block or
  - transit messages are forwarded to a destination outside the current ShardChain forwarded from `InMsgDescr`.

#### 区块头和验证者签名

一个分片链块和状态分为两部分：

- `workchain_id`
- Binary prefix of `account_ids`
- Block sequence number. The smallest non-negative integer greater than its predecessors' sequence numbers.
- Logical time and UNIX time of generation
- Hashes of:
  - The block's predecessor(s) (two, in the case of a merge)
  - The block's initial and final states
  - The latest known MasterChain block at the time of block generation

After the block is created, validator signatures are appended to produce a signed block.

#### 出站消息队列

The `OutMsgQueue` is another crucial non-split component of the ShardChain state. It holds undelivered outbound messages, as recorded in `OutMsgDescr`, from either the latest block or one of its predecessors.
Each outgoing message is initially placed in `OutMsgQueue`, which remains until it is successfully delivered to its target.

#### 分片的拆分和合并机制

Shard configurations can change over time due to split or merge events in dynamic sharding. These changes are coordinated via the MasterChain.
When a split or merge is triggered, the affected shards pause and wait for the next MasterChain block before resuming activity.

## 参阅

- [区块布局](/v3/documentation/data-formats/tlb/block-layout)
- [白皮书](/v3/documentation/whitepapers/overview)

<Feedback />
