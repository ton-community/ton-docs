import Feedback from '@site/src/components/Feedback';

# Nominator pool

一个名为 "提名者池 "的智能合约可以让一个或多个提名者借出 Toncoin 作为验证者的股份，并确保验证者只能将 Toncoin 用于验证。此外，智能合约还保证了奖励的分配。 It ensures validator funds are used exclusively for validation and guarantees proper reward distribution.

## 架构

![image](/img/nominator-pool/nominator-pool.png)

## 限制

The pool is designed for large amounts of coins, prioritizing security and code simplicity. 池不支持小额存款，也不支持在一个资金池中有大量提名人。 The target configuration is:

- Minimum nominator stake: 10,000 TON
- Maximum nominators per pool: 40 (untested beyond this limit)

## 费用

In the TON blockchain, the validator cycle is approximately 18 hours, and there are roughly 40.5 validation rounds per month (assuming a 30-day month).

Here's the breakdown of costs based on participation:

- **Participating in only odd or even cycles (half of the rounds):**

  - Rounds per month: ~20.25
  - Cost per round: ~5 Toncoins
  - `total cost = 20.25 * 5 -> ~101.25 Toncoins`

- **Participating in both odd and even cycles (all rounds):**
  - Rounds per month: ~40.5
  - Cost per round : ~ 5 Toncoins
  - `total cost = 40.5 * 5 -> ~202.50 Toncoins`

## 奖励分配

After each validation round, the pool recovers its stake plus rewards from the elector contract. Rewards are split as follows:

```
validator_reward = (reward * validator_reward_share) / 10000;
nominators_reward = reward - validator_reward;
```

Nominators receive shares proportional to their stakes. 例如，如果池中有两个提名人，质押分别为 10 万 TON 和 30 万 TON ，那么第一个提名人将获得 "提名人奖励 "的 25%，第二个提名人将获得 "提名人奖励 "的 75%。

### Slashing

For validation fines:

1. Deduct from validator funds first
2. If insufficient, deduct from nominators proportionally
3. 请注意，提名池的设计方式是，验证器的资金应始终足以支付最高罚款。

## Validator requirements

The pool participates in validation only when:

- 只有当验证器资金超过不可变池参数 `min_validator_stake` 时，池才能参与验证。
- Validator funds cover maximum possible fines (based on network config)

## Nominator's messages

To interact with the nominator pool, nominators send simple messages with a text comment (from any wallet application) to the pool smart contract.
All messages must be sent in **bounceable mode** to prevent fund loss from errors.

### Deposit

Send a message with the comment "d" and amount ≥ `min_nominator_stake + 1 TON`.

Deposits:

- 如果池当前未参与验证（"state ==0"），则存款将立即存入。
- Queue as `pending_deposit_amount` if pool active
- 需要注意的是，如果提名人池中的提名人数已经达到 "max_nominators_count"（最大提名人数），那么来自新提名人的存款将被拒绝（会被退回给发件人）。

### 紧急撤离

Send a message with the comment "w" and 1 TON for fees:

- Executes immediately if funds are available
- Queues as `withdraw_request` otherwise
- Full withdrawal only (no partial withdrawals)

## 验证器退出

验证人可以从池中提取不属于提名人的所有代币。

## Key management

参与者必须保管好自己的私人密钥

- 如果提名人丢失了存款的钱包，将无法从资金池中提取资金。
- Lost validator wallet = lost validator funds

:::info
一个池参与者的钱包私钥丢失不会影响其他参与者。
:::

## Emergency operations

在正常运行时，验证器必须定期向提名者集群发送操作信息，例如 `process withdraw requests`, `update current validator set`, `new_stake`, `recover_stake` 。 验证软件 mytonctrl 会自动完成这项工作。

## 网络配置提案投票

在此基础上，验证器通过验证器软件将最终投票结果发送给网络配置智能合约。

1. Proposals announced via [@tonblockchain](https://t.me/tonblockchain) or [@tonstatus](https://t.me/tonstatus) with HEX hashes like `D855FFBCF813E50E10BEAB902D1177529CE79785CAE913EB96A72AE8EFBCBF47`
2. Nominators vote by sending a message to the nominator pool:
   - `y<HASH>` to support
   - `n<HASH>` to oppose
     > Please attach a small amount of tokens (minimum 1 TON) to this message to cover the network fee. Any unspent TON will be automatically returned to your wallet.
3. Validator submits final vote based on pool consensus
4. 投票将在投票池合约中保存 30 天。

## Get methods

#### 获取方法 `get_pool_data`

Returns complete pool state information as a tuple containing:

1. state - uint - 提名者当前的状态。0 - 不参与验证，1 - 发送了参与验证的 "new_stake "请求，2 - 收到了参与验证的成功确认。

2. nominators_count - uint - 当前提名池中的提名人数。

3. `stake_amount_sent` (nanotons)\
   The current validation stake amount

4. validator_amount - nanotons  - 验证器拥有的硬币数量。

5. `validator_address` (uint, immutable)\
   Validator wallet address. address - 投票人地址。要获取提名人地址，执行 `"0:"。+ dec_to_hex(address)`，如果`address = validator_address`，则执行`"-1:" + dec_to_hex(address)`。

6. 验证器根据不可变的池参数 `validator_reward_share` 获得奖励份额。 For example 4000 = 40%

```
validator_reward_share - immutable - uint - 验证器从验证中获得的奖励份额。 `validator_reward = (reward * validator_reward_share) / 10000`。  例如，设置 4000 可获得 40%。
```

7. max_nominators_count - immutable - uint - 提名者数量上限。

8. min_validator_stake - immutable - nanotons  - 本池中验证器的最小质押。

9. min_nominator_stake - immutable - nanotons  - 提名者在本池中的最小质押。

10. nominators - Cell - 含提名人的原始字典。

11. withdraw_requests -  cell  - 包含提名人撤回请求的原始字典。

12. `stake_at` (uint)\
    Next validation round ID, which is supposed to start at [`utime_since`](/v3/documentation/network/configs/blockchain-configs#configuration-parameters-4)

13. saved_validator_set_hash - uint - 技术信息。

14. validator_set_changes_count - uint - 技术信息。

15. validator_set_change_time - uint - 技术信息。

16. `stake_held_for` (uint)\
    Stake lock duration

17. config_proposal_votings -  cell  - 包含配置建议投票的原始字典。

#### 获取方法 `list_nominators`

Returns an array of all nominators with their:

1. `address` (uint)\
   BaseChain address. Convert with `"0:" + dec_to_hex(address)`.
2. `amount` (nanotons)\
   Active stake balance
3. `pending_deposit_amount` (nanotons)\
   Queued deposit amount
4. withdraw_request - int - 如果 `-1`，则该提名人发出了提取全部资金的请求。

#### 获取方法 `get_nominator_data`

Returns detailed nominator information for the specified address.

> Address must be in raw format without the `0:` prefix.

1. `amount` (nanotons) - Active stake
2. pending_deposit_amount - nanotons  - 将在下一轮验证时加入提名者有效质押的存款金额。
3. withdraw_request - int - 如果 `-1`，则该提名人发出了提取全部资金的请求。

如果提名池中没有这样的提名者，则抛出 `86` 错误。

**Example**:\
For nominator `EQA0i8-CdGnF_DhUHHf92R1ONH6sIA9vLZ_WLcCIhfBBXwtG`:

```bash
get_nominator_data 0x348bcf827469c5fc38541c77fdd91d4e347eac200f6f2d9fd62dc08885f0415f
```

### 提名人投票

#### 获取方法 `list_votes`

Returns all active proposals with the following:

1. proposal_hash - uint - 提案的哈希值。使用 `dec_too_hex(proposal_hash)` 将哈希值转换为 HEX 格式。
2. votes_create_time - uint - 创建此投票的时间。

#### 获取方法 `list_voters`

Returns voting details per proposal:

1. `address` (uint)
   - address - uint - 提名者钱包地址。要获取地址，请执行 `"0:"。+ dec_to_hex(address)`。
   - validator_address - immutable - uint - 验证器钱包地址。要获取地址，请执行 `"-1:" + dec_to_hex(validator_address)`。
2. `support` (int)
   - `-1` = For
   - `0` = Against
3. vote_time - uint - 他投票的时间。

投票结果在链外计算。

## 与钱包应用程序集成

对于存款、取款和投票，可向资金池发送简单的信息，并在信息中添加上述所需的文字注释。 发送存款时，可以将发送的金额存储在本地存储中。 发送再存款时，也将其添加到此金额中。

要找出当前利润，请调用获取方法 `get_nominator_data(your_address)`。利润将为（`金额 + 待处理存款金额 - 已存储在本地存储区的发送金额`）。

```python
pending_deposit_amount - nanotons  - 将在下一轮验证时加入提名者有效质押的存款金额。
```

要获取数据池的信息，请调用 `get_pool_data` 和 `list_nominators` 获取方法。

## 另请参见

- [提名者池合约](https://github.com/ton-blockchain/nominator-pool)
- [如何使用提名池](/v3/guidelines/smart-contracts/howto/nominator-pool)

<Feedback />
