import Feedback from '@site/src/components/Feedback';

# TON DHT service

Please see the implementations:

- [DHT](https://github.com/ton-blockchain/ton/tree/master/dht)
- [DHT Server](https://github.com/ton-blockchain/ton/tree/master/dht-server)

## Overview

The Kademlia-like Distributed Hash Table (DHT) plays a crucial role in the networking aspect of the TON project, enabling the discovery of other nodes within the network.

The keys used in the TON DHT are 256-bit integers, often derived from the SHA‑256 hash of a TL‑serialized object.

The values associated with these 256-bit keys are essentially arbitrary byte strings of limited length. The meaning of these byte strings is determined by the preimage of the corresponding key; this is typically known by both the node performing the key lookup and the node storing the key.

In its simplest form, the key represents an ADNL address of a node, while the value could be its IP address and port.

The key-value mappings of the TON DHT are maintained on the DHT nodes.

## DHT nodes

Each DHT node has a 256-bit DHT address. Unlike an ADNL address, a DHT address is typically kept stable so that other nodes can locate stored keys.

The value for key `K` is expected to be stored on the `S` nodes nearest to `K` by Kademlia distance.

Kademlia distance is calculated by performing a 256-bit `XOR` operation between the key `K` and the node’s identifier (key ID). This distance is unrelated to geographic location.

`S` is a small parameter that helps improve the reliability of the DHT. If the key were stored only on a single node (the nearest one to `K`), the value of that key would be lost if that node were to go offline.

## Kademlia routing table

A node participating in a DHT typically maintains a Kademlia routing table that groups known nodes into buckets by exponentially increasing Kademlia distance from the node’s own identifier. Each bucket holds a limited number of the “best” nodes, along with some additional candidate nodes.

The information stored in these buckets includes the DHT addresses, IP addresses, UDP ports, and availability details, such as the timestamp and latency of the last ping.

When a Kademlia node discovers another Kademlia node through a query, it places that node into the appropriate bucket as a candidate. If some of the “best” nodes in that bucket become unresponsive (for example, if they do not reply to ping queries for an extended period), they can be replaced by some of these candidates. This process ensures that the Kademlia routing table remains populated.

## Key-value pairs

Key-value pairs can be added and updated in the TON DHT. The rules for these updates can vary. In some cases, they allow the old value to be replaced with a new one if the update satisfies the key’s update rule (for example, a valid signature for `dht.updateRule.signature` by the owner of the associated private key). The signature must be retained alongside the value so it can be verified by other nodes.

In other cases, the old value impacts the new value in some way. For example, the value may include metadata such as a version that influences update acceptance. This helps prevent replay attacks.

The TON DHT is not only used to store the IP addresses of ADNL nodes; it also serves other purposes. It can store a list of addresses of nodes that are holding a specific torrent in TON Storage, a list of addresses of nodes included in an overlay subnetwork, ADNL addresses of TON services, and ADNL addresses published by services on the TON Blockchain, among others.

:::info
Learn more about TON DHT in the [DHT](/v3/documentation/network/protocols/dht/dht-deep-dive) documentation or in Chapter 3.2 of the [TON Whitepaper](https://docs.ton.org/ton.pdf).
:::

<Feedback />
