import Feedback from '@site/src/components/Feedback';

# Performance monitoring

## Monitoring TON server performance

Tools such as `htop`, `iotop`, `iftop`, `dstat`, and `nmon` are effective for measuring real-time system performance; however, they fall short when it comes to troubleshooting performance issues that have occurred in the past.

This guide recommends using the Linux SAR (System Activity Report) utility for monitoring the performance of TON servers, and it provides an explanation of how to use it effectively.

:::tip
This guideline helps to identify whether your server experiences a resource shortage, not whether the validator engine performs badly.
:::

### Installation

#### SAR Installation

```bash
sudo apt-get install sysstat
```

#### Enable automatic statistics gathering

```bash
sudo sed -i 's/false/true/g' /etc/default/sysstat
```

#### Enable the service

```bash
sudo systemctl enable sysstat sysstat-collect.timer sysstat-summary.timer
```

#### Start the service

```bash
sudo systemctl start sysstat sysstat-collect.timer sysstat-summary.timer
```

### Usage

By default, the SAR gathers statistics every 10 minutes and shows statistics for the current day, starting at midnight. You can check it by running the SAR without parameters:

```bash
sar
```

If you want to see statistics of the previous day or two days before, pass the number as an option:

```bash
sar -1   # previous day
sar -2   # two days ago
```

For the exact date, you should use the f option to point to the `sa` file of a given day within a month. Thus, for the September 23rd it would be:

```bash
sar -f /var/log/sysstat/sa23
```

To identify performance issues, it is essential to run specific SAR reports and analyze their results effectively.

The following list outlines the SAR commands that can be used to gather various system statistics. By combining these commands with the provided options, you can quickly generate reports for the desired date.

### Memory report

```bash
sar -rh
```

The TON validator engine uses the **jemalloc** feature, which allows it to cache a significant amount of data. You will typically see a high value in the `kbcached` column. Linux counts page cache as used; low values in the `kbmemfree` column alone aren’t an issue—monitor swap activity (`sar -Sh`) and OOM events. Consider adding more RAM if `%memused` stays high (e.g., >90%) together with swap usage. Additionally, keep an eye on your validator engine to ensure it doesn't stop unexpectedly due to an out-of-memory (OOM) issue. The best way to check for this is to grep the `/var/ton-work/log` directory, for example: `grep -i "Signal" /var/ton-work/log/*`.

**Swap usage:**

```bash
sar -Sh
```

If you notice that swap is in use, consider disabling swap for production validator nodes.

### CPU report

```bash
sar -u
```

If your server utilizes CPU on average up to 70% (see the `%user` column), this should be considered good for production validator nodes.

### Disk usage report

```bash
sar -dh
```

Watch the `%util` column and react accordingly if it stays above 90% for a particular disk.

### Network report

Use the following commands:

```bash
sar -n DEV -h
```

or

```bash
sar -n DEV -h --iface=<interface name>
```

if you want to filter results by network interface name.

Check the `%ifutil` column; it shows your interface utilization relative to its maximum link speed.

You can check which link speed your NIC supports by executing the command below:

```bash
cat /sys/class/net/<interface>/speed
```

:::info
Link speed reflects the negotiated NIC link rate; actual throughput may differ from your provider’s advertised bandwidth.
:::

Consider upgrading your link if `%ifutil` is above 70% or if `rxkB/s` and `txkB/s` are close to your provisioned bandwidth, especially for production validator nodes.

### Reporting a performance issue

Before reporting any performance issues, ensure that you meet the [minimum requirements](/v3/guidelines/nodes/running-nodes/validator-node#minimal-hardware-requirements) for the node. Then, execute the following commands:

To generate today's report, run:

```bash
sar -rudh | cat && sar -n DEV -h --iface=eno1 | cat > report_today.txt
```

For yesterday's report, use the following command:

```bash
sar -rudh -1 | cat && sar -n DEV -h --iface=eno1 -1 | cat > report_yesterday.txt
```

Additionally, stop the TON node and measure your disk I/O and network speed with the command below:

```bash
sudo fio --randrepeat=1 --ioengine=io_uring --direct=1 --gtod_reduce=1 --name=test --filename=/var/ton-work/testfile --bs=4096 --iodepth=1 --size=40G --readwrite=randread --numjobs=1 --group_reporting
```

Look for the value at `read: IOPS=` and include it in your report. A value above **10K IOPS** is considered good for production validator nodes.

Check your download and upload speeds using the following command:

```bash
curl -s https://raw.githubusercontent.com/sivel/speedtest-cli/master/speedtest.py | python3 -
```

Speeds exceeding **700 Mbit/s** are deemed satisfactory for production validator nodes.

When reporting, please send the SAR report, IOPS, and network speed results to [@mytonctrl_help_bot](https://t.me/mytonctrl_help_bot).

Initial version - _[@neodix](https://t.me/neodix) - TON Core team_, Sep 23, 2024

<Feedback />
