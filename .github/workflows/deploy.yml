name: Deploy

on:
  push:
#    branches:
#      - main
  workflow_dispatch:
    inputs:
      env:
        description: 'Environment to deploy'
        type: environment
        required: true

jobs:
  params:
    runs-on: ubuntu-latest
    steps:
      - name: Define param
        run: |
          echo "ENV=${{ inputs.env || 'staging' }}" >> "$GITHUB_OUTPUT"

  deploy:
    needs: params
    permissions:
      packages: write
      contents: read
    uses: ton-studio/backend-deploy-template/.github/workflows/deploy.yml@main
    secrets: inherit
    with:
      ENVIRONMENT: "${{ needs.params.outputs.ENV }}"
      DOCKERFILE: "./deployment/Docker/Dockerfile"
      AWS_REGION: ${{ vars.AWS_REGION }}
      AWS_CLUSTER: "${{ vars.AWS_CLUSTER }}"
      SENTRY_URL: ${{ vars.SENTRY_URL }}

      APP_NAME: ${{ vars.APP_NAME }}

      APP_ENV: "${{ vars.APP_ENV }}"
      APP_DOMAIN: "${{ vars.APP_DOMAIN }}"
      CHECKOUT_FETCH_DEPTH: '0'
      CHECKOUT_SUBMODULES: 'recursive'

      RUNNER: ''
      ENABLE_DEPLOY_BOT: "1"
